- name: "MEDIUM | V-1097 | AUDIT | The system must lockout accounts after 3 invalid logon attempts within a specified time period."
  win_shell: net accounts | select-string -Pattern "threshold"
  register: lockout_threshold_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1097

- name: "MEDIUM | V-1097 | PATCH | The system must lockout accounts after 3 invalid logon attempts within a specified time period."
  win_shell: net accounts /lockoutthreshold:5
  when: "'5' not in lockout_threshold_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-1097

- name: "MEDIUM | V-1099 | AUDIT | The account lockout duration must be configured to require an administrator to unlock an account."
  debug: var=secedit_rules.System_Access.LockoutDuration
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1099

- name: "MEDIUM | V-1099 | PATCH | The account lockout duration must be configured to require an administrator to unlock an account."
  win_secedit: 
      category: 'System Access'
      key: LockoutDuration
      value: -1
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-1099

# V-1098 must run after V-1099 because Windows won't allow setting ResetLockoutCount higher than LockoutDuration or setting LockoutDuration
# lower than ResetLockoutCount unless it's set to -1, which is done in V-1099.

- name: "MEDIUM | V-1098 | AUDIT | The period of time before the invalid logon counter is reset must be configured to at least 60 minutes."
  debug: var=secedit_rules.System_Access.ResetLockoutCount
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1098

- name: "MEDIUM | V-1098 | PATCH | The period of time before the invalid logon counter is reset must be configured to at least 60 minutes."
  win_secedit: 
      category: 'System Access'
      key: ResetLockoutCount
      value: 99999
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-1098

- name: "MEDIUM | V-1104 | AUDIT | The maximum password age must be configured to 60 days or less."
  win_shell: net accounts | Select-String -Pattern "Max"
  register: max_password_age_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1104

- name: "MEDIUM | V-1104 | PATCH | The maximum password age must be configured to 60 days or less."
  win_command: net accounts /maxpwage:60
  when: "'60' not in max_password_age_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-1104

- name: "MEDIUM | V-1105 | AUDIT | The minimum password age must be configured to at least 1 day."
  debug: var=secedit_rules.System_Access.MinimumPasswordAge
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1105

- name: "MEDIUM | V-1105 | PATCH | The minimum password age must be configured to at least 1 day."
  win_command: net accounts /minpwage:0
  when: secedit_rules.System_Access.MinimumPasswordAge != "0"
  tags:
      - cat2
      - medium
      - patch
      - V-1105

- name: "MEDIUM | V-1107 | AUDIT | The password history must be configured to 24 passwords remembered."
  debug: var=secedit_rules.System_Access.PasswordHistorySize
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1107

- name: "MEDIUM | V-1107 | PATCH | The password history must be configured to 24 passwords remembered."
  win_secedit:
      category: 'System Access'
      key: PasswordHistorySize
      value: '12'
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-1107

- name: "MEDIUM | V-1113 | AUDIT | The built-in guest account must be disabled."
  debug: var=secedit_rules.System_Access.EnableGuestAccount
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1113

- name: "MEDIUM | V-1113 | PATCH | The built-in guest account must be disabled."
  win_secedit:
      category: 'System Access'
      key: EnableGuestAccount
      value: '0'
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-1113

- name: "MEDIUM | V-1114 | AUDIT | The built-in guest account will be renamed."
  debug: var=secedit_rules.System_Access.NewGuestName
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1114

# - name: "MEDIUM | V-1114 | PATCH | The built-in guest account will be renamed."
#   win_secedit:
#       category: 'System Access'
#       key: NewGuestName
#       # Need single quote and double quote because secedit prepends and apends \" to value like \"value\" 
#       value: '"Administrator"'
#   register: secedit
#   failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
#   tags:
#       - cat2
#       - medium
#       - patch
#       - V-1114

- name: "MEDIUM | V-1115 | AUDIT | The built-in administrator account will be renamed."
  debug: var=secedit_rules.System_Access.NewAdministratorName
  register: result
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1115

# - name: "MEDIUM | V-1115 | PATCH | The built-in administrator account will be renamed."
#   win_command: true
#   tags:
#       - cat2
#       - medium
#       - patch
#       - V-1115

- name: "MEDIUM | V-1119 | AUDIT | Booting into alternate non STIG compliant operating systems will not be permitted."
  win_command: bcdedit
  register: OS_list_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1119

- name: "MEDIUM | V-1120 | AUDIT | Installed FTP server will not be configured to allow prohibited logins."
  win_shell: (Get-Service -name *ftpsvc).Status
  register: ftp_service_audit
  check_mode: no
  changed_when: no
  failed_when: "ftp_service_audit.stderr and service_not_found not in ftp_service_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1120

######################################### block start ###################################################

- block:
    - name: "MEDIUM | V-1120 | AUDIT | Get environment temp directory"
      win_shell: echo $env:temp
      register: temp_dir

    - name: "MEDIUM | V-1120 | AUDIT | Copy over ftp script"
      win_copy: 
          src: 1120.txt
          dest: "{{ temp_dir.stdout_lines[0] }}"
      register: copy_hotfix
      check_mode: no

    - name: "MEDIUM | V-1120 | AUDIT | Installed FTP server will not be configured to allow prohibited logins."
      win_command: ftp -s:{{ temp_dir.stdout_lines[0] }}\1120.txt
      register: ftp_anonymous_audit
      check_mode: no
      changed_when: no

    - name: "MEDIUM | V-1120 | Clean up."
      win_file:
          path: "{{ temp_dir.stdout_lines[0] }}/1120.txt"
          state: absent
      check_mode: no

  when: "'Running' in ftp_service_audit.stdout"
  tags:
      - cat2
      - medium
      - audit
      - V-1120
######################################### block end #####################################################

# - name: "MEDIUM | V-1120 | PATCH | Installed FTP server will not be configured to allow prohibited logins."
#   win_command: true
#   tags:
#       - cat2
#       - medium
#       - patch
#       - V-1120

- name: "MEDIUM | V-1141 | AUDIT | Unencrypted passwords must not be sent to third-party SMB Servers."
  win_command: reg query HKLM\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters /v EnablePlainTextPassword
  register: plain_text_password_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in plain_text_password_audit.stderr and plain_text_password_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1141

- name: "MEDIUM | V-1141 | PATCH | Unencrypted passwords must not be sent to third-party SMB Servers."
  win_regedit:
      key: 'HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters'
      value: EnablePlainTextPassword
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1141

- name: "MEDIUM | V-1145 | AUDIT | Automatic logons must be disabled."
  win_command: reg query \"HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\" /v AutoAdminLogon
  register: disable_automatic_logons_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_automatic_logons_audit.stderr and disable_automatic_logons_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1145

- name: "MEDIUM | V-1145 | PATCH | Automatic logons must be disabled."
  win_regedit:
      key: 'HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon'
      value: AutoAdminLogon
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1145

- name: "MEDIUM | V-1150 | AUDIT | The built-in Windows password complexity policy must be enabled."
  debug: var=secedit_rules.System_Access.PasswordComplexity
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1150

- name: "MEDIUM | V-1150 | PATCH | The built-in Windows password complexity policy must be enabled."
  win_secedit:
      category: 'System Access'
      key: PasswordComplexity
      value: '1'
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-1150

- name: "MEDIUM | V-1154 | AUDIT | The Ctrl+Alt+Del security attention sequence for logons will be enabled."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v DisableCAD
  register: disable_CAD_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_CAD_audit.stderr and disable_CAD_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1154

- name: "MEDIUM | V-1154 | PATCH | The Ctrl+Alt+Del security attention sequence for logons will be enabled."
  win_regedit: 
      key: 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System'
      value: DisableCAD
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1154

- name: "MEDIUM | V-1155 | AUDIT | The Deny access to this computer from the network user right on member servers must be configured to prevent access from highly privileged domain accounts and all local accounts on domain systems and unauthenticated access on all systems."
  debug: var=secedit_rules.Privilege_Rights.SeDenyNetworkLogonRight
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-1155

# Well-known security identifiers in Windows operating systems
# https://support.microsoft.com/en-us/kb/243330
- name: "MEDIUM | V-1155 | PATCH | The Deny access to this computer from the network user right on member servers must be configured to prevent access from highly privileged domain accounts and all local accounts on domain systems and unauthenticated access on all systems."
  win_secedit:
      category: 'Privilege Rights'
      key: SeDenyNetworkLogonRight
      value: '*S-1-5-32-546' # Guests group
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-1155

- name: "MEDIUM | V-1162 | AUDIT | The Windows SMB server will perform SMB packet signing when possible."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LanManServer\Parameters /v EnableSecuritySignature
  register: SMB_server_packet_signing_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in SMB_server_packet_signing_audit.stderr and SMB_server_packet_signing_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1162

- name: "MEDIUM | V-1163 | AUDIT | Outgoing secure channel traffic will be encrypted when possible."
  win_command: reg query HKLM\System\CurrentControlSet\Services\Netlogon\Parameters /v SealSecureChannel
  register: encrypt_outgoing_secure_channel_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in encrypt_outgoing_secure_channel_audit.stderr and encrypt_outgoing_secure_channel_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1163

- name: "MEDIUM | V-1163 | PATCH | Outgoing secure channel traffic will be encrypted when possible."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters'
      value: SealSecureChannel
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1163

- name: "MEDIUM | V-1164 | AUDIT | Outgoing secure channel traffic will be signed when possible."
  win_command: reg query HKLM\System\CurrentControlSet\Services\Netlogon\Parameters /v SignSecureChannel
  register: sign_outgoing_secure_channel_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in sign_outgoing_secure_channel_audit.stderr and sign_outgoing_secure_channel_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1164

- name: "MEDIUM | V-1164 | PATCH | Outgoing secure channel traffic will be signed when possible."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters'
      value: SignSecureChannel
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-1164

- name: "MEDIUM | V-1166 | AUDIT | The Windows SMB client will be enabled to perform SMB packet signing when possible."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LanmanWorkstation\Parameters /v EnableSecuritySignature
  register: SMB_client_packet_signing_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in SMB_client_packet_signing_audit.stderr and SMB_client_packet_signing_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1166

- name: "MEDIUM | V-1171 | AUDIT | Ejection of removable NTFS media is not restricted to Administrators."
  win_command: reg query \"HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\" /v AllocateDASD
  register: eject_removable_media_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in eject_removable_media_audit.stderr and eject_removable_media_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-1171

- name: "MEDIUM | V-1171 | PATCH | Ejection of removable NTFS media is not restricted to Administrators."
  win_regedit:
      key: 'HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon'
      value: AllocateDASD
      data: 0
      datatype: string
  tags:
      - cat2
      - medium
      - patch
      - V-1171

- name: "MEDIUM | V-2372 | AUDIT | Reversible password encryption will be disabled."
  debug: var=secedit_rules.System_Access.ClearTextPassword
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-2372

- name: "MEDIUM | V-2372 | PATCH | Reversible password encryption will be disabled."
  win_secedit:
      category: 'System Access'
      key: ClearTextPassword
      value: '0'
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-2372

- name: "MEDIUM | V-3245 | AUDIT | File share ACLs will be reconfigured to remove the Everyone group."
  win_shell:  Get-WmiObject -Class Win32_Share | Get-Acl | fl
  register: eject_removable_media_audit
  check_mode: no
  changed_when: no
  failed_when: "path_is_null not in eject_removable_media_audit.stderr and eject_removable_media_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3245

- name: "MEDIUM | V-3374 | AUDIT | The system must be configured to require a strong session key."
  win_command: reg query HKLM\System\CurrentControlSet\Services\Netlogon\Parameters\ /v RequireStrongKey
  register: strong_sessionkey_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in strong_sessionkey_audit.stderr and strong_sessionkey_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3374

- name: "MEDIUM | V-3374 | PATCH | The system must be configured to require a strong session key."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters\'
      value: RequireStrongKey
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3374

- name: "MEDIUM | V-3376 | AUDIT | The system will be configured to prevent the storage of passwords and credentials"
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v DisableDomainCreds
  register: creds_storage_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in creds_storage_audit.stderr and creds_storage_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3376

- name: "MEDIUM | V-3376 | PATCH | The system will be configured to prevent the storage of passwords and credentials"
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: DisableDomainCreds
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3376

- name: "MEDIUM | V-3377 | AUDIT | The system will be configured to prevent anonymous users from having the same rights as the Everyone group."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v EveryoneIncludesAnonymous
  register: everyone_includes_anon_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in everyone_includes_anon_audit.stderr and everyone_includes_anon_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3377

- name: "MEDIUM | V-3377 | PATCH | The system will be configured to prevent anonymous users from having the same rights as the Everyone group."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: EveryoneIncludesAnonymous
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3377

- name: "MEDIUM | V-3378 | AUDIT | The system will be configured to use the Classic security model."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v ForceGuest
  register: classic_security_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in classic_security_audit.stderr and classic_security_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3378

- name: "MEDIUM | V-3378 | PATCH | The system will be configured to use the Classic security model."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: ForceGuest
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3378

- name: "MEDIUM | V-3381 | AUDIT | The system will be configured to the required LDAP client signing level."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LDAP /v LDAPClientIntegrity
  register: LDAP_client_integrity_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in LDAP_client_integrity_audit.stderr and LDAP_client_integrity_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3381

- name: "MEDIUM | V-3381 | PATCH | The system will be configured to the required LDAP client signing level."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Services\LDAP'
      value: LDAPClientIntegrity
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3381

- name: "MEDIUM | V-3382 | AUDIT | The system will be configured to meet the minimum session security requirement for NTLM SSP based clients."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa\MSV1_0 /v NTLMMinClientSec
  register: NTLM_min_client_sec_audit
  check_mode: no
  changed_when: "'0x20080000' not in NTLM_min_client_sec_audit.stdout"
  failed_when: "reg_not_found not in NTLM_min_client_sec_audit.stderr and NTLM_min_client_sec_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3382

- name: "MEDIUM | V-3382 | PATCH | The system will be configured to meet the minimum session security requirement for NTLM SSP based clients."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa\MSV1_0'
      value: NTLMMinClientSec
      data: 0x20080000
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3382

- name: "MEDIUM | V-3383 | AUDIT | The system must be configured to use FIPS-compliant algorithms for encryption, hashing, and signing."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa\FIPSAlgorithmPolicy /v Enabled
  register: FIPS_compliant_algorithms_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in FIPS_compliant_algorithms_audit.stderr and FIPS_compliant_algorithms_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3383

# - name: "MEDIUM | V-3383 | PATCH | The system must be configured to use FIPS-compliant algorithms for encryption, hashing, and signing."
#   win_command: true
#   tags:
#       - cat2
#       - medium
#       - patch
#       - V-3383

- name: "MEDIUM | V-3385 | AUDIT | The system must be configured to require case insensitivity for non-Windows subsystems."
  win_command: reg query \"HKLM\System\CurrentControlSet\Control\Session Manager\Kernel\" /v ObCaseInsensitive
  register: case_insensitive_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in case_insensitive_audit.stderr and case_insensitive_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3385

- name: "MEDIUM | V-3385 | PATCH | The system must be configured to require case insensitivity for non-Windows subsystems."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Session Manager\Kernel'
      value: ObCaseInsensitive
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3385

- name: "MEDIUM | V-3449 | AUDIT | Remote Desktop Services will limit users to one remote session."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fSingleSessionPerUser
  register: single_rdp_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in single_rdp_audit.stderr and single_rdp_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3449

- name: "MEDIUM | V-3449 | PATCH | Remote Desktop Services will limit users to one remote session."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fSingleSessionPerUser
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3449

- name: "MEDIUM | V-3453 | AUDIT | Remote Desktop Services will always prompt a client for passwords upon connection."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fPromptForPassword
  register: rdp_password_prompt_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in rdp_password_prompt_audit.stderr and rdp_password_prompt_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3453

- name: "MEDIUM | V-3453 | PATCH | Remote Desktop Services will always prompt a client for passwords upon connection."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fPromptForPassword
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3453

- name: "MEDIUM | V-3454 | AUDIT | Remote Desktop Services will be configured with the client connection encryption set to the required level."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v MinEncryptionLevel
  register: min_encrypt_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in min_encrypt_audit.stderr and min_encrypt_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3454

- name: "MEDIUM | V-3455 | AUDIT | Remote Desktop Services will be configured to use session-specific temporary folders."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v PerSessionTempDir
  register: temp_folder_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in temp_folder_audit.stderr and temp_folder_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3455

- name: "MEDIUM | V-3455 | PATCH | Remote Desktop Services will be configured to use session-specific temporary folders."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: PerSessionTempDir
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3455

- name: "MEDIUM | V-3456 | AUDIT | Remote Desktop Services will delete temporary folders when a session is terminated."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v DeleteTempDirsOnExit
  register: delete_temp_folder_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in delete_temp_folder_audit.stderr and delete_temp_folder_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3456

- name: "MEDIUM | V-3456 | PATCH | Remote Desktop Services will delete temporary folders when a session is terminated."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: DeleteTempDirsOnExit
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3456

- name: "MEDIUM | V-3457 | AUDIT | Remote Desktop Services will be configured to set a time limit for disconnected sessions."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v MaxDisconnectionTime
  register: max_disconnection_time_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in max_disconnection_time_audit.stderr and max_disconnection_time_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3457

- name: "MEDIUM | V-3457 | PATCH | Remote Desktop Services will be configured to set a time limit for disconnected sessions."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: MaxDisconnectionTime
      data: 0x0000ea60
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3457

- name: "MEDIUM | V-3458 | AUDIT | Remote Desktop Services will be configured to disconnect an idle session after the specified time period."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v MaxIdleTime
  register: max_idle_time_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in max_idle_time_audit.stderr and max_idle_time_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3458

- name: "MEDIUM | V-3458 | PATCH | Remote Desktop Services will be configured to disconnect an idle session after the specified time period."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: MaxIdleTime
      data: 0x000dbba0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3458

- name: "MEDIUM | V-3469 | AUDIT | The system will be configured to enable the background refresh of Group Policy."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\system /v DisableBkGndGroupPolicy
  register: background_group_policy_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in background_group_policy_audit.stderr and background_group_policy_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3469

- name: "MEDIUM | V-3469 | PATCH | The system will be configured to enable the background refresh of Group Policy."
  win_regedit:
      key: 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\system'
      value: DisableBkGndGroupPolicy
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3469

- name: "MEDIUM | V-3470 | AUDIT | The system will be configured to prevent unsolicited remote assistance offers."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fAllowUnsolicited
  register: unsolicited_remote_assistance_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in unsolicited_remote_assistance_audit.stderr and unsolicited_remote_assistance_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3470

- name: "MEDIUM | V-3470 | PATCH | The system will be configured to prevent unsolicited remote assistance offers."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fAllowUnsolicited
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3470

- name: "MEDIUM | V-3479 | AUDIT | The system will be configured to use Safe DLL Search Mode."
  win_command: reg query \"HKLM\System\CurrentControlSet\Control\Session Manager\" /v SafeDllSearchMode
  register: safe_DLL_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in safe_DLL_audit.stderr and safe_DLL_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3479

- name: "MEDIUM | V-3479 | PATCH | The system will be configured to use Safe DLL Search Mode."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Session Manager'
      value: SafeDllSearchMode
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3479

- name: "MEDIUM | V-3480 | AUDIT | Media Player must be configured to prevent automatic checking for updates."
  win_command: reg query HKLM\Software\Policies\Microsoft\WindowsMediaPlayer /v DisableAutoupdate
  register: WMP_auto_update_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in WMP_auto_update_audit.stderr and WMP_auto_update_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3480

- name: "MEDIUM | V-3480 | PATCH | Media Player must be configured to prevent automatic checking for updates."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\WindowsMediaPlayer'
      value: DisableAutoupdate
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3480

- name: "MEDIUM | V-3481 | AUDIT | Media Player will be configured to prevent automatic Codec downloads."
  win_command: reg query HKCU\Software\Policies\Microsoft\WindowsMediaPlayer /v PreventCodecDownload
  register: WMP_codec_download_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in WMP_codec_download_audit.stderr and WMP_codec_download_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3481

- name: "MEDIUM | V-3481 | PATCH | Media Player will be configured to prevent automatic Codec downloads."
  win_regedit:
      key: 'HKCU:\Software\Policies\Microsoft\WindowsMediaPlayer'
      value: PreventCodecDownload
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3481

- name: "MEDIUM | V-3487 | AUDIT | Services will be documented and unnecessary services will not be installed or will be disabled."
  win_shell: Get-Service | Where-Object {$_.Status -eq "Running"}
  register: running_services_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-3487

- name: "MEDIUM | V-3666 | AUDIT | The system will be configured to meet the minimum session security requirement for NTLM SSP based servers."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa\MSV1_0 /v NTLMMinServerSec
  register: NTLM_min_server_sec_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in NTLM_min_server_sec_audit.stderr and NTLM_min_server_sec_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-3666

- name: "MEDIUM | V-3666 | PATCH | The system will be configured to meet the minimum session security requirement for NTLM SSP based servers."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa\MSV1_0'
      value: NTLMMinServerSec
      data: 0x20080000
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-3666

- name: "MEDIUM | V-4446 | AUDIT | Software certificate restriction policies will be enforced."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\Safer\CodeIdentifiers /v AuthenticodeEnabled
  register: software_restricition_policies_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in software_restricition_policies_audit.stderr and software_restricition_policies_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-4446

- name: "MEDIUM | V-4446 | PATCH | Software certificate restriction policies will be enforced."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\Safer\CodeIdentifiers'
      value: AuthenticodeEnabled
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-4446

- name: "MEDIUM | V-4447 | AUDIT | The Remote Desktop Session Host will require secure RPC communications."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fEncryptRPCTraffic
  register: encrypt_RPC_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in encrypt_RPC_audit.stderr and encrypt_RPC_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-4447

- name: "MEDIUM | V-4447 | PATCH | The Remote Desktop Session Host will require secure RPC communications."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fEncryptRPCTraffic
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-4447

- name: "MEDIUM | V-4448 | AUDIT | Group Policy objects will be reprocessed even if they have not changed."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows\Group Policy\{35378EAC-683F-11D2-A89A-00C04FBBCFA2}\" /v NoGPOListChanges
  register: reprocess_GPO_audit
  check_mode: no
  changed_when: no
  when: ansible_powershell_version == 4
  failed_when: "reg_not_found not in reprocess_GPO_audit.stderr and reprocess_GPO_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-4448

- name: "MEDIUM | V-4448 | AUDIT | Group Policy objects will be reprocessed even if they have not changed."
  win_shell: reg query "HKLM\Software\Policies\Microsoft\Windows\Group Policy\{35378EAC-683F-11D2-A89A-00C04FBBCFA2}" /v NoGPOListChanges
  register: reprocess_GPO_audit
  check_mode: no
  changed_when: no
  when: ansible_powershell_version == 3
  failed_when: "'ERROR: Invalid syntax' in reprocess_GPO_audit.module_stdout"
  tags:
      - cat2
      - medium
      - audit
      - V-4448

- name: "MEDIUM | V-4448 | PATCH | Group Policy objects will be reprocessed even if they have not changed."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\Group Policy\{35378EAC-683F-11D2-A89A-00C04FBBCFA2}'
      value: NoGPOListChanges
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-4448

- name: "MEDIUM | V-6831 | AUDIT | Outgoing secure channel traffic will be encrypted or signed."
  win_command: reg query HKLM\System\CurrentControlSet\Services\Netlogon\Parameters /v RequireSignOrSeal
  register: encrypt_or_sign_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in encrypt_or_sign_audit.stderr and encrypt_or_sign_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-6831

- name: "MEDIUM | V-6831 | PATCH | Outgoing secure channel traffic will be encrypted or signed."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Services\Netlogon\Parameters'
      value: RequireSignOrSeal
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-6831

- name: "MEDIUM | V-6832 | AUDIT | The Windows SMB client will be enabled to always perform SMB packet signing."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LanmanWorkstation\Parameters /v RequireSecuritySignature
  register: require_SMB_client_packet_signing_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in require_SMB_client_packet_signing_audit.stderr and require_SMB_client_packet_signing_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-6832

- name: "MEDIUM | V-6833 | AUDIT | The Windows SMB server will be enabled to always perform SMB packet signing."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LanManServer\Parameters /v RequireSecuritySignature
  register: require_SMB_server_packet_signing_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in require_SMB_server_packet_signing_audit.stderr and require_SMB_server_packet_signing_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-6833

- name: "MEDIUM | V-6836 | AUDIT | For systems utilizing a logon ID as the individual identifier, passwords will, at a minimum, be 14 characters."
  debug: var=secedit_rules.System_Access.MinimumPasswordLength
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-6836

- name: "MEDIUM | V-6836 | PATCH | For systems utilizing a logon ID as the individual identifier, passwords will, at a minimum, be 14 characters."
  win_secedit: 
      category: 'System Access'
      key: MinimumPasswordLength
      value: '8'
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-6836

- name: "MEDIUM | V-6840 | AUDIT | System mechanisms will be implemented to enforce automatic expiration of passwords."
  win_shell: (Get-WmiObject -Class Win32_UserAccount -Filter "PasswordExpires=$False and Domain='$env:computername'").Name
  register: password_expiry_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-6840

- name: "MEDIUM | V-14228 | AUDIT | Auditing Access of Global System Objects must be turned off."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v AuditBaseObjects
  register: audit_base_objects_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in audit_base_objects_audit.stderr and audit_base_objects_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14228

- name: "MEDIUM | V-14228 | PATCH | Auditing Access of Global System Objects must be turned off."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: AuditBaseObjects
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14228

- name: "MEDIUM | V-14229 | AUDIT | Audit of Backup and Restore Privileges will be turned off."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v FullPrivilegeAuditing
  register: full_privilege_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in full_privilege_audit.stderr and full_privilege_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14229

# win_regedit requires 2 octects for binary values to detect if a change is needed or not.
- name: "MEDIUM | V-14229 | PATCH | Audit of Backup and Restore Privileges will be turned off."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: FullPrivilegeAuditing
      data: 0x0,0x0
      datatype: binary
  tags:
      - cat2
      - medium
      - patch
      - V-14229

- name: "MEDIUM | V-14230 | AUDIT | Audit policy using subcategories will be enabled."
  win_command: reg query HKLM\System\CurrentControlSet\Control\Lsa /v SCENoApplyLegacyAuditPolicy
  register: subcategories_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in subcategories_audit.stderr and subcategories_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14230

- name: "MEDIUM | V-14230 | PATCH | Audit policy using subcategories will be enabled."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\Lsa'
      value: SCENoApplyLegacyAuditPolicy
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14230

- name: "MEDIUM | V-14234 | AUDIT | User Account Control approval mode for the built-in Administrator will be enabled."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v FilterAdministratorToken
  register: admin_approval_mode_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in admin_approval_mode_audit.stderr and admin_approval_mode_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14234

- name: "MEDIUM | V-14235 | AUDIT | User Account Control will, at a minimum, prompt administrators for consent."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v ConsentPromptBehaviorAdmin
  register: admin_consent_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in admin_consent_audit.stderr and admin_consent_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14235

- name: "MEDIUM | V-14236 | AUDIT | User Account Control will automatically deny standard user requests for elevation."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v ConsentPromptBehaviorUser
  register: user_consent_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in user_consent_audit.stderr and user_consent_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14236

- name: "MEDIUM | V-14239 | AUDIT | User Account Control will only elevate UIAccess applications that are installed in secure locations"
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v EnableSecureUIAPaths
  register: enable_secure_UIA_paths_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in enable_secure_UIA_paths_audit.stderr and enable_secure_UIA_paths_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14239

- name: "MEDIUM | V-14240 | AUDIT | User Account Control will run all administrators in Admin Approval Mode, enabling UAC."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA
  register: enable_UAC
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in enable_UAC.stderr and enable_UAC.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14240

- name: "MEDIUM | V-14241 | AUDIT | User Account Control will switch to the secure desktop when prompting for elevation."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v PromptOnSecureDesktop
  register: prompt_on_secure_desktop_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in prompt_on_secure_desktop_audit.stderr and prompt_on_secure_desktop_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14241

- name: "MEDIUM | V-14242 | AUDIT | User Account Control will virtualize file and registry write failures to per-user locations."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v EnableVirtualization
  register: UAC_virtualization_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in UAC_virtualization_audit.stderr and UAC_virtualization_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14242

- name: "MEDIUM | V-14247 | AUDIT | Passwords will not be saved in the Remote Desktop Client."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v DisablePasswordSaving
  register: disable_RDC_password_saving_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_RDC_password_saving_audit.stderr and disable_RDC_password_saving_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14247

- name: "MEDIUM | V-14247 | PATCH | Passwords will not be saved in the Remote Desktop Client."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: DisablePasswordSaving
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14247

- name: "MEDIUM | V-14249 | AUDIT | Local drives will be prevented from sharing with Remote Desktop Session Hosts (Remote Desktop Services Role)."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fDisableCdm
  register: disable_local_drive_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_local_drive_audit.stderr and disable_local_drive_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14249

- name: "MEDIUM | V-14249 | PATCH | Local drives will be prevented from sharing with Remote Desktop Session Hosts (Remote Desktop Services Role)."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fDisableCdm
      data: 1
      datatype: dword
  tags:
    - cat2
    - medium
    - patch
    - V-14249

- name: "MEDIUM | V-14253 | AUDIT | Unauthenticated RPC clients must be restricted from connecting to the RPC server."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Rpc\" /v RestrictRemoteClients
  register: restrict_remote_clients_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in restrict_remote_clients_audit.stderr and restrict_remote_clients_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14253

- name: "MEDIUM | V-14253 | PATCH | Unauthenticated RPC clients must be restricted from connecting to the RPC server."
  win_regedit: 
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Rpc'
      value: RestrictRemoteClients
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14253

- name: "MEDIUM | V-14254 | AUDIT | Client computers must be required to authenticate for RPC communication."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Rpc\" /v EnableAuthEpResolution
  register: require_auth_RPC_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in require_auth_RPC_audit.stderr and require_auth_RPC_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14254

- name: "MEDIUM | V-14254 | PATCH | Client computers must be required to authenticate for RPC communication."
  win_regedit: 
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Rpc'
      value: EnableAuthEpResolution
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14254

- name: "MEDIUM | V-14259 | AUDIT | Printing over HTTP will be prevented."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Printers\" /v DisableHTTPPrinting
  register: disable_HTTP_printing_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_HTTP_printing_audit.stderr and disable_HTTP_printing_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14259

- name: "MEDIUM | V-14259 | PATCH | Printing over HTTP will be prevented."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Printers'
      value: DisableHTTPPrinting
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14259

- name: "MEDIUM | V-14260 | AUDIT | Downloading print driver packages over HTTP will be prevented."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Printers\" /v DisableWebPnPDownload
  register: disable_HTTP_printer_drivers_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_HTTP_printer_drivers_audit.stderr and disable_HTTP_printer_drivers_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14260

- name: "MEDIUM | V-14260 | PATCH | Downloading print driver packages over HTTP will be prevented."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Printers'
      value: DisableWebPnPDownload
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14260

- name: "MEDIUM | V-14261 | AUDIT | Windows will be prevented from using Windows Update to search for drivers."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\DriverSearching /v DontSearchWindowsUpdate
  register: windows_update_driver_search_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in windows_update_driver_search_audit.stderr and windows_update_driver_search_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14261

- name: "MEDIUM | V-14261 | PATCH | Windows will be prevented from using Windows Update to search for drivers."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\DriverSearching'
      value: DontSearchWindowsUpdate
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14261

- name: "MEDIUM | V-14268 | AUDIT | Zone information will be preserved when saving attachments."
  win_command: reg query HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\Attachments /v SaveZoneInformation
  register: save_zone_info_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in save_zone_info_audit.stderr and save_zone_info_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14268

- name: "MEDIUM | V-14268 | PATCH | Zone information will be preserved when saving attachments."
  win_regedit:
      key: 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies\Attachments'
      value: SaveZoneInformation
      data: 2
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14268

- name: "MEDIUM | V-14269 | AUDIT | Mechanisms for removing zone information from file attachments will be hidden."
  win_command: reg query HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\Attachments /v HideZoneInfoOnProperties
  register: hide_zone_info_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in hide_zone_info_audit.stderr and hide_zone_info_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-14269

- name: "MEDIUM | V-14269 | PATCH | Mechanisms for removing zone information from file attachments will be hidden."
  win_regedit:
      key: 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies\Attachments'
      value: HideZoneInfoOnProperties
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-14269

- name: "MEDIUM | V-15505 | AUDIT | The HBSS McAfee Agent will be installed."
  win_shell: 'Get-ChildItem C:\ -Filter "FrameworkService.exe" -Recurse -ErrorAction SilentlyContinue | % { $_.FullName }'
  register: macfee_framework_service_path_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-15505

- name: "MEDIUM | V-15505 | AUDIT | The HBSS McAfee Agent will be installed."
  win_shell: '[System.Diagnostics.FileVersionInfo]::GetVersionInfo("{{ item }}") | % {$_.FileName, (($_.FileMajorPart, $_.FileMinorPart, $_.FileBuildPart, $_.FilePrivatePart) -join".")}'
  register: macfee_framework_service_version_audit
  check_mode: no
  changed_when: no
  with_items:
      - "{{ macfee_framework_service_path_audit.stdout_lines }}"
  tags:
      - cat2
      - medium
      - audit
      - V-15505

- name: "MEDIUM | V-15666 | AUDIT | Windows Peer-to-Peer networking services will be turned off."
  win_command: reg query HKLM\Software\Policies\Microsoft\Peernet /v Disabled
  register: p2p_net_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in p2p_net_audit.stderr and p2p_net_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15666

- name: "MEDIUM | V-15666 | PATCH | Windows Peer-to-Peer networking services will be turned off."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Peernet'
      value: Disabled
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15666

- name: "MEDIUM | V-15667 | AUDIT | Network Bridges will be prohibited in Windows."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows\Network Connections\" /v NC_AllowNetBridge_NLA
  register: network_bridge_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in network_bridge_audit.stderr and network_bridge_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15667

- name: "MEDIUM | V-15667 | PATCH | Network Bridges will be prohibited in Windows."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\Network Connections'
      value: NC_AllowNetBridge_NLA
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15667

- name: "MEDIUM | V-15682 | AUDIT | Attachments must be prevented from being downloaded from RSS feeds."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Internet Explorer\Feeds\" /v DisableEnclosureDownload
  register: no_attachments_from_RSS_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in no_attachments_from_RSS_audit.stderr and no_attachments_from_RSS_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15682

- name: "MEDIUM | V-15682 | PATCH | Attachments must be prevented from being downloaded from RSS feeds."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Internet Explorer\Feeds'
      value: DisableEnclosureDownload
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15682

- name: "MEDIUM | V-15683 | AUDIT | Windows Explorer shell protocol will run in protected mode."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer /v PreXPSP2ShellProtocolBehavior
  register: shell_protocol_protected_mode_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in shell_protocol_protected_mode_audit.stderr and shell_protocol_protected_mode_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15683

- name: "MEDIUM | V-15684 | AUDIT | Users will be notified if a web-based program attempts to install software."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\Installer /v SafeForScripting
  register: install_notification_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in install_notification_audit.stderr and install_notification_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15684

- name: "MEDIUM | V-15684 | PATCH | Users will be notified if a web-based program attempts to install software."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\Installer'
      value: SafeForScripting
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15684

- name: "MEDIUM | V-15696 | AUDIT | The Mapper I/O network protocol driver will be disabled."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\LLTD /v {{ item }}
  register: disable_mapper_IO_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_mapper_IO_audit.stderr and disable_mapper_IO_audit.stderr"
  with_items:
      - AllowLLTDIOOndomain
      - AllowLLTDIOOnPublicNet
      - EnableLLTDIO
      - ProhibitLLTDIOOnPrivateNet
  tags:
      - cat2
      - medium
      - audit
      - V-15696

- name: "MEDIUM | V-15696 | PATCH | The Mapper I/O network protocol driver will be disabled."
  win_regedit: 
      key: 'HKLM:\Software\Policies\Microsoft\Windows\LLTD'
      value: "{{ item }}"
      data: 0
      datatype: dword
  with_items: 
      - AllowLLTDIOOndomain
      - AllowLLTDIOOnPublicNet
      - EnableLLTDIO
      - ProhibitLLTDIOOnPrivateNet
  tags:
      - cat2
      - medium
      - patch
      - V-15696

- name: "MEDIUM | V-15697 | AUDIT | The Responder network protocol driver will be disabled."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\LLTD /v {{ item }}
  register: diable_responder_protocol_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in diable_responder_protocol_audit.stderr and diable_responder_protocol_audit.stderr"
  with_items:
      - AllowRspndrOndomain
      - AllowRspndrOnPublicNet
      - EnableRspndr
      - ProhibitRspndrOnPrivateNet
  tags:
      - cat2
      - medium
      - audit
      - V-15697

- name: "MEDIUM | V-15697 | PATCH | The Responder network protocol driver will be disabled."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\LLTD'
      value: "{{ item }}"
      data: 0
      datatype: dword
  with_items:
      - AllowRspndrOndomain
      - AllowRspndrOnPublicNet
      - EnableRspndr
      - ProhibitRspndrOnPrivateNet
  tags:
      - cat2
      - medium
      - patch
      - V-15697

- name: "MEDIUM | V-15698 | AUDIT | The configuration of wireless devices using Windows Connect Now will be disabled."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\WCN\Registrars /v {{ item }}
  register: WCN_config_drivers_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in WCN_config_drivers_audit.stderr and WCN_config_drivers_audit.stderr"
  with_items:
      - DisableFlashConfigRegistrar
      - DisableInBand802DOT11Registrar
      - DisableUPnPRegistrar
      - DisableWPDRegistrar
      - EnableRegistrars
  tags:
      - cat2
      - medium
      - audit
      - V-15698

- name: "MEDIUM | V-15698 | PATCH | The configuration of wireless devices using Windows Connect Now will be disabled."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\WCN\Registrars'
      value: "{{ item }}"
      data: 0
      datatype: dword
  with_items:
      - DisableFlashConfigRegistrar
      - DisableInBand802DOT11Registrar
      - DisableUPnPRegistrar
      - DisableWPDRegistrar
      - EnableRegistrars
  tags:
      - cat2
      - medium
      - patch
      - V-15698

- name: "MEDIUM | V-15699 | AUDIT | The Windows Connect Now wizards will be disabled."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\WCN\UI /v DisableWcnUi
  register: disable_WCN_UI_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_WCN_UI_audit.stderr and disable_WCN_UI_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15699

- name: "MEDIUM | V-15699 | PATCH | The Windows Connect Now wizards will be disabled."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\WCN\UI'
      value: DisableWcnUi
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15699

- name: "MEDIUM | V-15700 | AUDIT | Remote access to the Plug and Play interface will be disabled for device installation."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\DeviceInstall\Settings /v AllowRemoteRPC
  register: PnP_device_install_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in PnP_device_install_audit.stderr and PnP_device_install_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15700

- name: "MEDIUM | V-15700 | PATCH | Remote access to the Plug and Play interface will be disabled for device installation."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\DeviceInstall\Settings'
      value: AllowRemoteRPC
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15700

- name: "MEDIUM | V-15705 | AUDIT | Users will be prompted for a password on resume from sleep (on battery).  (Applicable to Server 2008 R2 if the system is configured to sleep.)"
  win_command: reg query HKLM\Software\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51 /v DCSettingIndex
  register: prompt_resume_DC_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in prompt_resume_DC_audit.stderr and prompt_resume_DC_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15705

- name: "MEDIUM | V-15705 | PATCH | Users will be prompted for a password on resume from sleep (on battery).  (Applicable to Server 2008 R2 if the system is configured to sleep.)"
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51'
      value: DCSettingIndex
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15705

- name: "MEDIUM | V-15706 | AUDIT | The user will be prompted for a password on resume from sleep (Plugged In).  (Applicable on Server 2008 R2 if the system is configured to sleep.)"
  win_command: reg query HKLM\Software\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51 /v ACSettingIndex
  register: prompt_resume_AC_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in prompt_resume_AC_audit.stderr and prompt_resume_AC_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15706

- name: "MEDIUM | V-15706 | PATCH | The user will be prompted for a password on resume from sleep (Plugged In).  (Applicable on Server 2008 R2 if the system is configured to sleep.)"
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Power\PowerSettings\0e796bdb-100d-47d6-a2d5-f7d2daa51f51'
      value: ACSettingIndex
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15706

- name: "MEDIUM | V-15713 | AUDIT | Windows Defender SpyNet membership will be disabled."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows Defender\Spynet\" /v SpyNetReporting
  register: disable_spynet_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_spynet_audit.stderr and disable_spynet_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15713

- name: "MEDIUM | V-15713 | PATCH | Windows Defender SpyNet membership will be disabled."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows Defender\Spynet'
      value: SpyNetReporting
      state: absent
  tags:
      - cat2
      - medium
      - patch
      - V-15713

- name: "MEDIUM | V-15714 | AUDIT | The system must be configured to save Error Reporting events and messages to the system event log."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v LoggingDisabled
  register: save_error_logging_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in save_error_logging_audit.stderr and save_error_logging_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15714

- name: "MEDIUM | V-15714 | PATCH | The system must be configured to save Error Reporting events and messages to the system event log."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: LoggingDisabled
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15714

- name: "MEDIUM | V-15715 | AUDIT | The system must be configured to generate error reports."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v Disabled
  register: enable_error_logging_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in enable_error_logging_audit.stderr and enable_error_logging_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15715

- name: "MEDIUM | V-15715 | PATCH | The system must be configured to generate error reports."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: Disabled
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15715

- name: "MEDIUM | V-15722 | AUDIT | Windows Media Digital Rights Management will be prevented from accessing the Internet."
  win_command: reg query HKLM\Software\Policies\Microsoft\WMDRM /v DisableOnline
  register: DRM_online_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in DRM_online_audit.stderr and DRM_online_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15722

- name: "MEDIUM | V-15722 | PATCH | Windows Media Digital Rights Management will be prevented from accessing the Internet."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\WMDRM'
      value: DisableOnline
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15722

- name: "MEDIUM | V-15727 | AUDIT | Users will be prevented from sharing files in their profiles."
  win_command: reg query HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer /v NoInPlaceSharing
  register: sharing_files_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in sharing_files_audit.stderr and sharing_files_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15727

- name: "MEDIUM | V-15727 | PATCH | Users will be prevented from sharing files in their profiles."
  win_regedit:
      key: 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer'
      value: NoInPlaceSharing
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15727

- name: "MEDIUM | V-15823 | AUDIT | Software certificate installation files will be removed from a system."
  win_command: wmic logicaldisk where drivetype=3 get name
  register: list_of_drives_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-15823

- name: "MEDIUM | V-15823 | AUDIT | Software certificate installation files will be removed from a system."
  win_shell: 'Get-ChildItem {{ item[0]|trim }}\ -Filter {{ item[1] }} -recurse -ErrorAction SilentlyContinue'
  register: certificate_installation_files_audit
  check_mode: no
  changed_when: no
  when: "'Name' not in item[0] and item[0]"
  with_nested: 
      - "{{ list_of_drives_audit.stdout_lines }}"
      - [ "*.p12", "*.pfx" ]
  tags:
      - cat2
      - medium
      - audit
      - V-15823

- name: "MEDIUM | V-15991 | AUDIT | UIAccess applications will not be allowed to prompt for elevation without using the secure desktop."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v EnableUIADesktopToggle
  register: UIA_desktop_toggle_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in UIA_desktop_toggle_audit.stderr and UIA_desktop_toggle_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15991

- name: "MEDIUM | V-15997 | AUDIT | The system will be configured to prevent users from mapping local COM ports and redirecting data from the Remote Desktop Session Host to local COM ports. (Remote Desktop Services Role)"
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fDisableCcm
  register: COM_port_redirection_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in COM_port_redirection_audit.stderr and COM_port_redirection_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15997

- name: "MEDIUM | V-15997 | PATCH | The system will be configured to prevent users from mapping local COM ports and redirecting data from the Remote Desktop Session Host to local COM ports. (Remote Desktop Services Role)"
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fDisableCcm
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15997

- name: "MEDIUM | V-15998 | AUDIT | The system will be configured to prevent users from mapping local LPT ports and redirecting data from the Remote Desktop Session Host to local LPT ports. (Remote Desktop Services Role)"
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fDisableLPT
  register: disable_LPT_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in disable_LPT_audit.stderr and disable_LPT_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15998

- name: "MEDIUM | V-15998 | PATCH | The system will be configured to prevent users from mapping local LPT ports and redirecting data from the Remote Desktop Session Host to local LPT ports. (Remote Desktop Services Role)"
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fDisableLPT
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15998

- name: "MEDIUM | V-15999 | AUDIT | The system will be configured to prevent users from redirecting Plug and Play devices to the Remote Desktop Session Host. (Remote Desktop Services Role)"
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fDisablePNPRedir
  register: PnP_redirect_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in PnP_redirect_audit.stderr and PnP_redirect_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-15999

- name: "MEDIUM | V-15999 | PATCH | The system will be configured to prevent users from redirecting Plug and Play devices to the Remote Desktop Session Host. (Remote Desktop Services Role)"
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fDisablePNPRedir
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-15999

- name: "MEDIUM | V-16000 | AUDIT | The system will be configured to ensure smart card devices can be redirected to the Remote Desktop Session. (Remote Desktop Services Role)"
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Windows NT\Terminal Services\" /v fEnableSmartCard
  register: smart_card_redirect_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in smart_card_redirect_audit.stderr and smart_card_redirect_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-16000

- name: "MEDIUM | V-16000 | PATCH | The system will be configured to ensure smart card devices can be redirected to the Remote Desktop Session. (Remote Desktop Services Role)"
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services'
      value: fEnableSmartCard
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-16000

- name: "MEDIUM | V-16008 | AUDIT | Windows will elevate all applications in User Account Control, not just signed ones."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v ValidateAdminCodeSignatures
  register: elevate_all_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in elevate_all_audit.stderr and elevate_all_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-16008

- name: "MEDIUM | V-16020 | AUDIT | The Windows Customer Experience Improvement Program will be disabled."
  win_command: reg query HKLM\Software\Policies\Microsoft\SQMClient\Windows /v CEIPEnable
  register: CEIP_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in CEIP_audit.stderr and CEIP_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-16020

- name: "MEDIUM | V-16020 | PATCH | The Windows Customer Experience Improvement Program will be disabled."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\SQMClient\Windows'
      value: CEIPEnable
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-16020

- name: "MEDIUM | V-16021 | AUDIT | The Windows Help Experience Improvement Program will be disabled"
  win_command: reg query HKCU\Software\Policies\Microsoft\Assistance\Client\1.0 /v NoImplicitFeedback
  register: WHEIP_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in WHEIP_audit.stderr and WHEIP_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-16021

- name: "MEDIUM | V-16021 | PATCH | The Windows Help Experience Improvement Program will be disabled"
  win_regedit:
      key: 'HKCU:\Software\Policies\Microsoft\Assistance\Client\1.0'
      value: NoImplicitFeedback
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-16021

- name: "MEDIUM | V-16048 | AUDIT | Windows Help Ratings feedback will be turned off."
  win_command: reg query HKCU\Software\Policies\Microsoft\Assistance\Client\1.0 /v NoExplicitFeedback
  register: help_ratings_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in help_ratings_audit.stderr and help_ratings_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-16048

- name: "MEDIUM | V-16048 | PATCH | Windows Help Ratings feedback will be turned off."
  win_regedit:
      key: 'HKCU:\Software\Policies\Microsoft\Assistance\Client\1.0'
      value: NoExplicitFeedback
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-16048

- name: "MEDIUM | V-21950 | AUDIT | The service principal name (SPN) target name validation level will be turned off."
  win_command: reg query HKLM\System\CurrentControlSet\Services\LanmanServer\Parameters /v SmbServerNameHardeningLevel
  register: SMB_server_name_level_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in SMB_server_name_level_audit.stderr and SMB_server_name_level_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-21950

- name: "MEDIUM | V-21951 | AUDIT | Services using Local System that use negotiate when reverting to NTLM authentication will use the computer identity vs. authenticating anonymously."
  win_command: reg query HKLM\System\CurrentControlSet\Control\LSA /v UseMachineId
  register: use_machine_ID_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in use_machine_ID_audit.stderr and use_machine_ID_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-21951

- name: "MEDIUM | V-21952 | AUDIT | NTLM will be prevented from falling back to a Null session."
  win_command: reg query HKLM\System\CurrentControlSet\Control\LSA\MSV1_0 /v allownullsessionfallback
  register: null_session_fallback_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in null_session_fallback_audit.stderr and null_session_fallback_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-21952

- name: "MEDIUM | V-21952 | PATCH | NTLM will be prevented from falling back to a Null session."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\LSA\MSV1_0'
      value: allownullsessionfallback
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-21952

- name: "MEDIUM | V-21953 | AUDIT | PKU2U authentication using online identities will be prevented."
  win_command: reg query HKLM\System\CurrentControlSet\Control\LSA\pku2u /v AllowOnlineID
  register: online_ID_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in online_ID_audit.stderr and online_ID_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-21953

- name: "MEDIUM | V-21953 | PATCH | PKU2U authentication using online identities will be prevented."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Control\LSA\pku2u'
      value: AllowOnlineID
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-21953

- name: "MEDIUM | V-21954 | AUDIT | Kerberos encryption types must be configured to prevent the use of DES encryption suites."
  win_command: reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos\Parameters /v SupportedEncryptionTypes
  register: kerberos_encryption_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in kerberos_encryption_audit.stderr and kerberos_encryption_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-21954

- name: "MEDIUM | V-21954 | PATCH | Kerberos encryption types must be configured to prevent the use of DES encryption suites."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos\Parameters'
      value: SupportedEncryptionTypes
      data: 0x7ffffffc
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-21954

- name: "MEDIUM | V-21980 | AUDIT | Explorer Data Execution Prevention will be enabled."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\Explorer /v NoDataExecutionPrevention
  register: DEP_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in DEP_audit.stderr and DEP_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-21980

- name: "MEDIUM | V-21980 | PATCH | Explorer Data Execution Prevention will be enabled."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\Explorer'
      value: NoDataExecutionPrevention
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-21980

- name: "MEDIUM | V-26469 | AUDIT | Unauthorized accounts must not have the Access Credential Manager as a trusted caller user right."
  debug: var=secedit_rules.Privilege_Rights.SeTrustedCredManAccessPrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26469

- name: "MEDIUM | V-26469 | PATCH | Unauthorized accounts must not have the Access Credential Manager as a trusted caller user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeTrustedCredManAccessPrivilege
      value: ''
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26469

- name: "MEDIUM | V-26470 | AUDIT | Unauthorized accounts must not have the Access this computer from the network user right on member servers."
  debug: var=secedit_rules.Privilege_Rights.SeNetworkLogonRight
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26470

- name: "MEDIUM | V-26470 | PATCH | Unauthorized accounts must not have the Access this computer from the network user right on member servers."
  win_secedit:
      category: 'Privilege Rights'
      key: SeNetworkLogonRight
      value: '*S-1-5-11,*S-1-5-32-544' #Authenticated Users, Administrators
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26470

- name: "MEDIUM | V-26471 | AUDIT | Unauthorized accounts must not have the Adjust memory quotas for a process user right."
  debug: var=secedit_rules.Privilege_Rights.SeIncreaseQuotaPrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26471

- name: "MEDIUM | V-26471 | PATCH | Unauthorized accounts must not have the Adjust memory quotas for a process user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeIncreaseQuotaPrivilege
      value: '*S-1-5-19,*S-1-5-20,*S-1-5-32-544' #Local Service, Network Service, Administrators
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26471

- name: "MEDIUM | V-26472 | AUDIT | Unauthorized accounts must not have the Allow log on locally user right."
  debug: var=secedit_rules.Privilege_Rights.SeInteractiveLogonRight
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26472

- name: "MEDIUM | V-26472 | PATCH | Unauthorized accounts must not have the Allow log on locally user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeInteractiveLogonRight
      value: '*S-1-5-32-544' #Administrators
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26472

- name: "MEDIUM | V-26473 | AUDIT | The Allow log on through Remote Desktop Services user right must only be assigned to the Administrators group and other approved groups."
  debug: var=secedit_rules.Privilege_Rights.SeRemoteInteractiveLogonRight
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26473

- name: "MEDIUM | V-26473 | PATCH | The Allow log on through Remote Desktop Services user right must only be assigned to the Administrators group and other approved groups."
  win_secedit:
      category: 'Privilege Rights'
      key: SeRemoteInteractiveLogonRight
      value: '*S-1-5-32-544' #Administrators
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26473

- name: "MEDIUM | V-26474 | AUDIT | Unauthorized accounts must not have the Back up files and directories user right."
  debug: var=secedit_rules.Privilege_Rights.SeBackupPrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26474

- name: "MEDIUM | V-26474 | PATCH | Unauthorized accounts must not have the Back up files and directories user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeBackupPrivilege
      value: '*S-1-5-32-544' #Administrators
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26474

- name: "MEDIUM | V-26476 | AUDIT | Unauthorized accounts must not have the Change the system time user right."
  debug: var=secedit_rules.Privilege_Rights.SeSystemtimePrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26476

- name: "MEDIUM | V-26476 | PATCH | Unauthorized accounts must not have the Change the system time user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeSystemtimePrivilege
      value: '*S-1-5-19,*S-1-5-32-544' #Local Service, Administrators
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26476

- name: "MEDIUM | V-26478 | AUDIT | Unauthorized accounts must not have the Create a pagefile user right."
  debug: var=secedit_rules.Privilege_Rights.SeCreatePagefilePrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26478

- name: "MEDIUM | V-26478 | PATCH | Unauthorized accounts must not have the Create a pagefile user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeCreatePagefilePrivilege
      value: '*S-1-5-32-544' #Administrators
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26478

- name: "MEDIUM | V-26480 | AUDIT | Unauthorized accounts must not have the Create global objects user right."
  debug: var=secedit_rules.Privilege_Rights.SeCreateGlobalPrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26480

- name: "MEDIUM | V-26480 | PATCH | Unauthorized accounts must not have the Create global objects user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeCreateGlobalPrivilege
      value: '*S-1-5-19,*S-1-5-20,*S-1-5-32-544,*S-1-5-6' #Local Service, Network Service, Administrators, Service
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26480

- name: "MEDIUM | V-26481 | AUDIT | Unauthorized accounts must not have the Create permanent shared objects user right."
  debug: var=secedit_rules.Privilege_Rights.SeCreatePermanentPrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26481

- name: "MEDIUM | V-26481 | PATCH | Unauthorized accounts must not have the Create permanent shared objects user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeCreatePermanentPrivilege
      value: ''
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26481

- name: "MEDIUM | V-26482 | AUDIT | Unauthorized accounts must not have the Create symbolic links user right."
  debug: var=secedit_rules.Privilege_Rights.SeCreateSymbolicLinkPrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26482

- name: "MEDIUM | V-26482 | PATCH | Unauthorized accounts must not have the Create symbolic links user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeCreateSymbolicLinkPrivilege
      value: '*S-1-5-32-544' #Administrators
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26482

- name: "MEDIUM | V-26483 | AUDIT | The Deny log on as a batch job user right on member servers must be configured to prevent access from highly privileged domain accounts on domain systems and unauthenticated access on all systems."
  debug: var=secedit_rules.Privilege_Rights.SeDenyBatchLogonRight
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26483

- name: "MEDIUM | V-26483 | PATCH | The Deny log on as a batch job user right on member servers must be configured to prevent access from highly privileged domain accounts on domain systems and unauthenticated access on all systems."
  win_secedit:
      category: 'Privilege Rights'
      key: SeDenyBatchLogonRight
      value: '*S-1-5-32-546' #Guests
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26483

- name: "MEDIUM | V-26484 | AUDIT | The Deny log on as a service user right on member servers must be configured to prevent access from highly privileged domain accounts on domain systems.  No other groups or accounts must be assigned this right."
  debug: var=secedit_rules.Privilege_Rights.SeDenyServiceLogonRight
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26484

- name: "MEDIUM | V-26484 | PATCH | The Deny log on as a service user right on member servers must be configured to prevent access from highly privileged domain accounts on domain systems.  No other groups or accounts must be assigned this right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeDenyServiceLogonRight
      value: ''
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26484

- name: "MEDIUM | V-26485 | AUDIT | The Deny log on locally user right on member servers must be configured to prevent access from highly privileged domain accounts on domain systems and unauthenticated access on all systems."
  debug: var=secedit_rules.Privilege_Rights.SeDenyInteractiveLogonRight
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26485

- name: "MEDIUM | V-26485 | PATCH | The Deny log on locally user right on member servers must be configured to prevent access from highly privileged domain accounts on domain systems and unauthenticated access on all systems."
  win_secedit:
      category: 'Privilege Rights'
      key: SeDenyInteractiveLogonRight
      value: '*S-1-5-32-546' #Guests
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26485

- name: "MEDIUM | V-26486 | AUDIT | The Deny log on through Remote Desktop Services user right on member servers must be configured to prevent access from highly privileged domain accounts and all local accounts on domain systems and unauthenticated access on all systems."
  debug: var=secedit_rules.Privilege_Rights.SeDenyRemoteInteractiveLogonRight
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26486

- name: "MEDIUM | V-26486 | PATCH | The Deny log on through Remote Desktop Services user right on member servers must be configured to prevent access from highly privileged domain accounts and all local accounts on domain systems and unauthenticated access on all systems."
  win_secedit:
      category: 'Privilege Rights'
      key: SeDenyRemoteInteractiveLogonRight
      value: '*S-1-5-32-546' #Guests
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26486

- name: "MEDIUM | V-26487 | AUDIT | Unauthorized accounts must not have the Enable computer and user accounts to be trusted for delegation user right."
  debug: var=secedit_rules.Privilege_Rights.SeEnableDelegationPrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26487

- name: "MEDIUM | V-26487 | PATCH | Unauthorized accounts must not have the Enable computer and user accounts to be trusted for delegation user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeEnableDelegationPrivilege
      value: '*S-1-5-32-544' #Administrators
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26487

- name: "MEDIUM | V-26488 | AUDIT | Unauthorized accounts must not have the Force shutdown from a remote system user right."
  debug: var=secedit_rules.Privilege_Rights.SeRemoteShutdownPrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26488

- name: "MEDIUM | V-26488 | PATCH | Unauthorized accounts must not have the Force shutdown from a remote system user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeRemoteShutdownPrivilege
      value: '*S-1-5-32-544' #Administrators
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26488

- name: "MEDIUM | V-26489 | AUDIT | Unauthorized accounts must not have the Generate security audits user right."
  debug: var=secedit_rules.Privilege_Rights.SeAuditPrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26489

- name: "MEDIUM | V-26489 | PATCH | Unauthorized accounts must not have the Generate security audits user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeAuditPrivilege
      value: '*S-1-5-19,*S-1-5-20' #Local Service, Network Service
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26489

- name: "MEDIUM | V-26490 | AUDIT | Unauthorized accounts must not have the Impersonate a client after authentication user right."
  debug: var=secedit_rules.Privilege_Rights.SeImpersonatePrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26490

- name: "MEDIUM | V-26490 | PATCH | Unauthorized accounts must not have the Impersonate a client after authentication user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeImpersonatePrivilege
      value: '*S-1-5-19,*S-1-5-20,*S-1-5-32-544,*S-1-5-6' #Local Service, Network Service, Administrators, Service
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26490

- name: "MEDIUM | V-26491 | AUDIT | Unauthorized accounts must not have the Increase a process working set user right."
  debug: var=secedit_rules.Privilege_Rights.SeIncreaseWorkingSetPrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26491

- name: "MEDIUM | V-26491 | PATCH | Unauthorized accounts must not have the Increase a process working set user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeIncreaseWorkingSetPrivilege
      value: '*S-1-5-19,*S-1-5-32-544' #Local Service, Administrators
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26491

- name: "MEDIUM | V-26492 | AUDIT | Unauthorized accounts must not have the Increase scheduling priority user right."
  debug: var=secedit_rules.Privilege_Rights.SeIncreaseBasePriorityPrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26492

- name: "MEDIUM | V-26492 | PATCH | Unauthorized accounts must not have the Increase scheduling priority user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeIncreaseBasePriorityPrivilege
      value: '*S-1-5-32-544' #Administrators
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26492

- name: "MEDIUM | V-26493 | AUDIT | Unauthorized accounts must not have the Load and unload device drivers user right."
  debug: var=secedit_rules.Privilege_Rights.SeLoadDriverPrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26493

- name: "MEDIUM | V-26493 | PATCH | Unauthorized accounts must not have the Load and unload device drivers user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeLoadDriverPrivilege
      value: '*S-1-5-32-544' #Administrators
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26493

- name: "MEDIUM | V-26494 | AUDIT | Unauthorized accounts must not have the Lock pages in memory user right."
  debug: var=secedit_rules.Privilege_Rights.SeLockMemoryPrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26494

- name: "MEDIUM | V-26494 | PATCH | Unauthorized accounts must not have the Lock pages in memory user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeLockMemoryPrivilege
      value: ''
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26494

- name: "MEDIUM | V-26495 | AUDIT | Unauthorized accounts must not have the Log on as a batch job user right."
  debug: var=secedit_rules.Privilege_Rights.SeBatchLogonRight
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26495

- name: "MEDIUM | V-26495 | PATCH | Unauthorized accounts must not have the Log on as a batch job user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeBatchLogonRight
      value: '*S-1-5-32-544' #Administrators
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26495

- name: "MEDIUM | V-26496 | AUDIT | Unauthorized accounts must not have the Manage auditing and security log user right."
  debug: var=secedit_rules.Privilege_Rights.SeSecurityPrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26496

- name: "MEDIUM | V-26496 | PATCH | Unauthorized accounts must not have the Manage auditing and security log user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeSecurityPrivilege
      value: '*S-1-5-32-544' #Administrators
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26496

- name: "MEDIUM | V-26497 | AUDIT | Unauthorized accounts must not have the Modify an object label user right."
  debug: var=secedit_rules.Privilege_Rights.SeRelabelPrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26497

- name: "MEDIUM | V-26497 | PATCH | Unauthorized accounts must not have the Modify an object label user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeRelabelPrivilege
      value: ''
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26497

- name: "MEDIUM | V-26498 | AUDIT | Unauthorized accounts must not have the Modify firmware environment values user right."
  debug: var=secedit_rules.Privilege_Rights.SeSystemEnvironmentPrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26498

- name: "MEDIUM | V-26498 | PATCH | Unauthorized accounts must not have the Modify firmware environment values user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeSystemEnvironmentPrivilege
      value: '*S-1-5-32-544' #Administrators
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26498

- name: "MEDIUM | V-26499 | AUDIT | Unauthorized accounts must not have the Perform volume maintenance tasks user right."
  debug: var=secedit_rules.Privilege_Rights.SeManageVolumePrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26499

- name: "MEDIUM | V-26499 | PATCH | Unauthorized accounts must not have the Perform volume maintenance tasks user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeManageVolumePrivilege
      value: '*S-1-5-32-544' #Administrators
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26499

- name: "MEDIUM | V-26500 | AUDIT | Unauthorized accounts must not have the Profile single process user right."
  debug: var=secedit_rules.Privilege_Rights.SeProfileSingleProcessPrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26500

- name: "MEDIUM | V-26500 | PATCH | Unauthorized accounts must not have the Profile single process user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeProfileSingleProcessPrivilege
      value: '*S-1-5-32-544' #Administrators
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26500

- name: "MEDIUM | V-26501 | AUDIT | Unauthorized accounts must not have the Profile system performance user right."
  debug: var=secedit_rules.Privilege_Rights.SeSystemProfilePrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26501

- name: "MEDIUM | V-26501 | PATCH | Unauthorized accounts must not have the Profile system performance user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeSystemProfilePrivilege
      value: '*S-1-5-32-544,*S-1-5-80-3139157870-2983391045-3678747466-658725712-1809340420' #Administrators, NT Service\WdiServiceHost
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26501

- name: "MEDIUM | V-26503 | AUDIT | Unauthorized accounts must not have the Replace a process level token user right."
  debug: var=secedit_rules.Privilege_Rights.SeAssignPrimaryTokenPrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26503

- name: "MEDIUM | V-26503 | PATCH | Unauthorized accounts must not have the Replace a process level token user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeAssignPrimaryTokenPrivilege
      value: '*S-1-5-19,*S-1-5-20' #Local Service, Network Service
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26503

- name: "MEDIUM | V-26504 | AUDIT | Unauthorized accounts must not have the Restore files and directories user right."
  debug: var=secedit_rules.Privilege_Rights.SeRestorePrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26504

- name: "MEDIUM | V-26504 | PATCH | Unauthorized accounts must not have the Restore files and directories user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeRestorePrivilege
      value: '*S-1-5-32-544' #Administrators
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26504

- name: "MEDIUM | V-26505 | AUDIT | Unauthorized accounts must not have the Shut down the system user right."
  debug: var=secedit_rules.Privilege_Rights.SeShutdownPrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26505

- name: "MEDIUM | V-26505 | PATCH | Unauthorized accounts must not have the Shut down the system user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeShutdownPrivilege
      value: '*S-1-5-32-544' #Administrators
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26505

- name: "MEDIUM | V-26506 | AUDIT | Unauthorized accounts must not have the Take ownership of files or other objects user right."
  debug: var=secedit_rules.Privilege_Rights.SeTakeOwnershipPrivilege
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26506

- name: "MEDIUM | V-26506 | PATCH | Unauthorized accounts must not have the Take ownership of files or other objects user right."
  win_secedit:
      category: 'Privilege Rights'
      key: SeTakeOwnershipPrivilege
      value: '*S-1-5-32-544' #Administrators
  register: secedit
  failed_when: "secedit.failed is defined and 'This host is joined to a Domain Controller' not in secedit.msg"
  tags:
      - cat2
      - medium
      - patch
      - V-26506

- name: "MEDIUM | V-26529 | AUDIT | The system will be configured to audit 'Account Logon -> Credential Validation' successes."
  win_shell: AuditPol /get /subcategory:"Credential Validation"
  register: success_cred_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26529

- name: "MEDIUM | V-26529 | PATCH | The system will be configured to audit 'Account Logon -> Credential Validation' successes."
  win_shell: AuditPol /set /subcategory:"Credential Validation" /success:enable
  when: "'Success' not in success_cred_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26529

- name: "MEDIUM | V-26530 | AUDIT | The system will be configured to audit 'Account Logon -> Credential Validation' failures."
  win_shell: AuditPol /get /subcategory:"Credential Validation"
  register: failure_cred_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26530

- name: "MEDIUM | V-26530 | PATCH | The system will be configured to audit 'Account Logon -> Credential Validation' failures."
  win_shell: AuditPol /set /subcategory:"Credential Validation" /failure:enable
  when: "'Failure' not in failure_cred_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26530

- name: "MEDIUM | V-26531 | AUDIT | The system will be configured to audit 'Account Management -> Computer Account Management' successes."
  win_shell: AuditPol /get /subcategory:"Computer Account Management"
  register: success_computer_account_management_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26531

- name: "MEDIUM | V-26531 | PATCH | The system will be configured to audit 'Account Management -> Computer Account Management' successes."
  win_shell: AuditPol /set /subcategory:"Computer Account Management" /success:enable
  when: "'Success' not in success_computer_account_management_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26531

- name: "MEDIUM | V-26532 | AUDIT | The system will be configured to audit 'Account Management -> Computer Account Management' failures."
  win_shell: AuditPol /get /subcategory:"Computer Account Management"
  register: failure_computer_account_management_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26532

- name: "MEDIUM | V-26532 | PATCH | The system will be configured to audit 'Account Management -> Computer Account Management' failures."
  win_shell: AuditPol /set /subcategory:"Computer Account Management" /failure:enable
  when: "'Failure' not in failure_computer_account_management_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26532

- name: "MEDIUM | V-26533 | AUDIT | The system will be configured to audit 'Account Management -> Other Account Management Events' successes."
  win_shell: AuditPol /get /subcategory:"Other Account Management Events"
  register: success_other_account_management_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26533

- name: "MEDIUM | V-26533 | PATCH | The system will be configured to audit 'Account Management -> Other Account Management Events' successes."
  win_shell: AuditPol /set /subcategory:"Other Account Management Events" /success:enable
  when: "'Success' not in success_other_account_management_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26533

- name: "MEDIUM | V-26534 | AUDIT | The system will be configured to audit 'Account Management -> Other Account Management Events' failures."
  win_shell: AuditPol /get /subcategory:"Other Account Management Events"
  register: failure_other_account_management_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26534

- name: "MEDIUM | V-26534 | PATCH | The system will be configured to audit 'Account Management -> Other Account Management Events' failures."
  win_shell: AuditPol /set /subcategory:"Other Account Management Events" /failure:enable
  when: "'Failure' not in failure_other_account_management_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26534

- name: "MEDIUM | V-26535 | AUDIT | The system will be configured to audit 'Account Management -> Security Group Management' successes."
  win_shell: AuditPol /get /subcategory:"Security Group Management"
  register: success_security_group_management_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26535

- name: "MEDIUM | V-26535 | PATCH | The system will be configured to audit 'Account Management -> Security Group Management' successes."
  win_shell: AuditPol /set /subcategory:"Security Group Management" /success:enable
  when: "'Success' not in success_security_group_management_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26535

- name: "MEDIUM | V-26536 | AUDIT | The system will be configured to audit 'Account Management -> Security Group Management' failures."
  win_shell: AuditPol /get /subcategory:"Security Group Management"
  register: failure_security_group_management_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26536

- name: "MEDIUM | V-26536 | PATCH | The system will be configured to audit 'Account Management -> Security Group Management' failures."
  win_shell: AuditPol /set /subcategory:"Security Group Management" /failure:enable
  when: "'Failure' not in failure_security_group_management_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26536

- name: "MEDIUM | V-26537 | AUDIT | The system will be configured to audit 'Account Management -> User Account Management' successes."
  win_shell: AuditPol /get /subcategory:"User Account Management"
  register: success_user_account_management_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26537

- name: "MEDIUM | V-26537 | PATCH | The system will be configured to audit 'Account Management -> User Account Management' successes."
  win_shell: AuditPol /set /subcategory:"User Account Management" /success:enable
  when: "'Success' not in success_user_account_management_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26537

- name: "MEDIUM | V-26538 | AUDIT | The system will be configured to audit 'Account Management -> User Account Management' failures."
  win_shell: AuditPol /get /subcategory:"User Account Management"
  register: failure_user_account_management_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26538

- name: "MEDIUM | V-26538 | PATCH | The system will be configured to audit 'Account Management -> User Account Management' failures."
  win_shell: AuditPol /set /subcategory:"User Account Management" /failure:enable
  when: "'Failure' not in failure_user_account_management_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26538

- name: "MEDIUM | V-26539 | AUDIT | The system will be configured to audit 'Detailed Tracking -> Process Creation' successes."
  win_shell: AuditPol /get /subcategory:"Process Creation"
  register: success_process_creation_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26539

- name: "MEDIUM | V-26539 | PATCH | The system will be configured to audit 'Detailed Tracking -> Process Creation' successes."
  win_shell: AuditPol /set /subcategory:"Process Creation" /success:enable
  when: "'Success' not in success_process_creation_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26539

- name: "MEDIUM | V-26540 | AUDIT | The system will be configured to audit 'Logon/Logoff -> Logoff' successes."
  win_shell: AuditPol /get /subcategory:"Logoff"
  register: success_logoff_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26540

- name: "MEDIUM | V-26540 | PATCH | The system will be configured to audit 'Logon/Logoff -> Logoff' successes."
  win_shell: AuditPol /set /subcategory:"Logoff" /success:enable
  when: "'Success' not in success_logoff_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26540

- name: "MEDIUM | V-26541 | AUDIT | The system will be configured to audit 'Logon/Logoff -> Logon' successes."
  win_shell: AuditPol /get /subcategory:"Logon"
  register: success_logon_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26541

- name: "MEDIUM | V-26541 | PATCH | The system will be configured to audit 'Logon/Logoff -> Logon' successes."
  win_shell: AuditPol /set /subcategory:"Logon" /success:enable
  when: "'Success' not in success_logon_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26541

- name: "MEDIUM | V-26542 | AUDIT | The system will be configured to audit 'Logon/Logoff -> Logon' failures."
  win_shell: AuditPol /get /subcategory:"Logon"
  register: failure_logon_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26542

- name: "MEDIUM | V-26542 | PATCH | The system will be configured to audit 'Logon/Logoff -> Logon' failures."
  win_shell: AuditPol /set /subcategory:"Logon" /failure:enable
  when: "'Failure' not in failure_logon_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26542

- name: "MEDIUM | V-26543 | AUDIT | The system will be configured to audit 'Logon/Logoff -> Special Logon' successes."
  win_shell: AuditPol /get /subcategory:"Special Logon"
  register: success_special_logon_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26543

- name: "MEDIUM | V-26543 | PATCH | The system will be configured to audit 'Logon/Logoff -> Special Logon' successes."
  win_shell: AuditPol /set /subcategory:"Special Logon" /success:enable
  when: "'Success' not in success_special_logon_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26543

- name: "MEDIUM | V-26546 | AUDIT | The system will be configured to audit 'Policy Change -> Audit Policy Change' successes."
  win_shell: AuditPol /get /subcategory:"Audit Policy Change"
  register: success_audit_policy_change_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26546

- name: "MEDIUM | V-26546 | PATCH | The system will be configured to audit 'Policy Change -> Audit Policy Change' successes."
  win_shell: AuditPol /set /subcategory:"Audit Policy Change" /success:enable
  when: "'Success' not in success_audit_policy_change_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26546

- name: "MEDIUM | V-26547 | AUDIT | The system will be configured to audit 'Policy Change -> Audit Policy Change' failures."
  win_shell: AuditPol /get /subcategory:"Audit Policy Change"
  register: failure_audit_policy_change_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26547

- name: "MEDIUM | V-26547 | PATCH | The system will be configured to audit 'Policy Change -> Audit Policy Change' failures."
  win_shell: AuditPol /set /subcategory:"Audit Policy Change" /failure:enable
  when: "'Failure' not in failure_audit_policy_change_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26547

- name: "MEDIUM | V-26548 | AUDIT | The system will be configured to audit 'Policy Change -> Authentication Policy Change' successes."
  win_shell: AuditPol /get /subcategory:"Authentication Policy Change"
  register: success_authentication_policy_change_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26548

- name: "MEDIUM | V-26548 | PATCH | The system will be configured to audit 'Policy Change -> Authentication Policy Change' successes."
  win_shell: AuditPol /set /subcategory:"Authentication Policy Change" /success:enable
  when: "'Success' not in success_authentication_policy_change_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26548

- name: "MEDIUM | V-26549 | AUDIT | The system will be configured to audit 'Privilege Use -> Sensitive Privilege Use' successes."
  win_shell: AuditPol /get /subcategory:"Sensitive Privilege Use"
  register: success_sensitive_privilege_use_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26549

- name: "MEDIUM | V-26549 | PATCH | The system will be configured to audit 'Privilege Use -> Sensitive Privilege Use' successes."
  win_shell: AuditPol /set /subcategory:"Sensitive Privilege Use" /success:enable
  when: "'Success' not in success_sensitive_privilege_use_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26549

- name: "MEDIUM | V-26550 | AUDIT | The system will be configured to audit 'Privilege Use -> Sensitive Privilege Use' failures."
  win_shell: AuditPol /get /subcategory:"Sensitive Privilege Use"
  register: failure_sensitive_privilege_use_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26550

- name: "MEDIUM | V-26550 | PATCH | The system will be configured to audit 'Privilege Use -> Sensitive Privilege Use' failures."
  win_shell: AuditPol /set /subcategory:"Sensitive Privilege Use" /failure:enable
  when: "'Failure' not in failure_sensitive_privilege_use_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26550

- name: "MEDIUM | V-26551 | AUDIT | The system will be configured to audit 'System -> IPSec Driver' successes."
  win_shell: AuditPol /get /subcategory:"IPSec Driver"
  register: success_IPSec_driver_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26551

- name: "MEDIUM | V-26551 | PATCH | The system will be configured to audit 'System -> IPSec Driver' successes."
  win_shell: AuditPol /set /subcategory:"IPSec Driver" /success:enable
  when: "'Success' not in success_IPSec_driver_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26551

- name: "MEDIUM | V-26552 | AUDIT | The system will be configured to audit 'System -> IPSec Driver' failures."
  win_shell: AuditPol /get /subcategory:"IPSec Driver"
  register: failure_IPSec_driver_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26552

- name: "MEDIUM | V-26552 | PATCH | The system will be configured to audit 'System -> IPSec Driver' failures."
  win_shell: AuditPol /set /subcategory:"IPSec Driver" /failure:enable
  when: "'Failure' not in failure_IPSec_driver_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26552

- name: "MEDIUM | V-26553 | AUDIT | The system will be configured to audit 'System -> Security State Change' successes."
  win_shell: AuditPol /get /subcategory:"Security State Change"
  register: success_security_state_change_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26553

- name: "MEDIUM | V-26553 | PATCH | The system will be configured to audit 'System -> Security State Change' successes."
  win_shell: AuditPol /set /subcategory:"Security State Change" /success:enable
  when: "'Success' not in success_security_state_change_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26553

- name: "MEDIUM | V-26554 | AUDIT | The system will be configured to audit 'System -> Security State Change' failures."
  win_shell: AuditPol /get /subcategory:"Security State Change"
  register: failure_security_state_change_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26554

- name: "MEDIUM | V-26554 | PATCH | The system will be configured to audit 'System -> Security State Change' failures."
  win_shell: AuditPol /set /subcategory:"Security State Change" /failure:enable
  when: "'Failure' not in failure_security_state_change_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26554

- name: "MEDIUM | V-26555 | AUDIT | The system will be configured to audit 'System -> Security System Extension' successes."
  win_shell: AuditPol /get /subcategory:"Security System Extension"
  register: success_security_system_extension_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26555

- name: "MEDIUM | V-26555 | PATCH | The system will be configured to audit 'System -> Security System Extension' successes."
  win_shell: AuditPol /set /subcategory:"Security System Extension" /success:enable
  when: "'Success' not in success_security_system_extension_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26555

- name: "MEDIUM | V-26556 | AUDIT | The system will be configured to audit 'System -> Security System Extension' failures."
  win_shell: AuditPol /get /subcategory:"Security System Extension"
  register: failure_security_system_extension_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26556

- name: "MEDIUM | V-26556 | PATCH | The system will be configured to audit 'System -> Security System Extension' failures."
  win_shell: AuditPol /set /subcategory:"Security System Extension" /failure:enable
  when: "'Failure' not in failure_security_system_extension_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26556

- name: "MEDIUM | V-26557 | AUDIT | The system will be configured to audit 'System -> System Integrity' successes."
  win_shell: AuditPol /get /subcategory:"System Integrity"
  register: success_system_integrity_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26557

- name: "MEDIUM | V-26557 | PATCH | The system will be configured to audit 'System -> System Integrity' successes."
  win_shell: AuditPol /set /subcategory:"System Integrity" /success:enable
  when: "'Success' not in success_system_integrity_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26557

- name: "MEDIUM | V-26558 | AUDIT | The system will be configured to audit 'System -> System Integrity' failures."
  win_shell: AuditPol /get /subcategory:"System Integrity"
  register: failure_system_integrity_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-26558

- name: "MEDIUM | V-26558 | PATCH | The system will be configured to audit 'System -> System Integrity' failures."
  win_shell: AuditPol /set /subcategory:"System Integrity" /failure:enable
  when: "'Failure' not in failure_system_integrity_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-26558

- name: "MEDIUM | V-26575 | AUDIT | The 6to4 IPv6 transition technology will be disabled."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\TCPIP\v6Transition /v 6to4_State
  register: six_to_four_audit
  check_mode: no
  changed_when: no
  failed_when: "six_to_four_audit.stderr and reg_not_found not in six_to_four_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-26575

- name: "MEDIUM | V-26575 | PATCH | The 6to4 IPv6 transition technology will be disabled."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\TCPIP\v6Transition'
      value: 6to4_State
      data: Disabled
      datatype: string
  tags:
      - cat2
      - medium
      - patch
      - V-26575

- name: "MEDIUM | V-26576 | AUDIT | The IP-HTTPS IPv6 transition technology will be disabled."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\TCPIP\v6Transition\IPHTTPS\IPHTTPSInterface /v IPHTTPS_ClientState
  register: IPv6_transition_audit
  check_mode: no
  changed_when: no
  failed_when: "IPv6_transition_audit.stderr and reg_not_found not in IPv6_transition_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-26576

- name: "MEDIUM | V-26576 | PATCH | The IP-HTTPS IPv6 transition technology will be disabled."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\TCPIP\v6Transition\IPHTTPS\IPHTTPSInterface'
      value: IPHTTPS_ClientState
      data: 3
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-26576

- name: "MEDIUM | V-26577 | AUDIT | The ISATAP IPv6 transition technology will be disabled."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\TCPIP\v6Transition /v ISATAP_State
  register: ISATAP_audit
  check_mode: no
  changed_when: no
  failed_when: "ISATAP_audit.stderr and reg_not_found not in ISATAP_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-26577

- name: "MEDIUM | V-26577 | PATCH | The ISATAP IPv6 transition technology will be disabled."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\TCPIP\v6Transition'
      value: ISATAP_State
      data: Disabled
      datatype: string
  tags:
      - cat2
      - medium
      - patch
      - V-26577

- name: "MEDIUM | V-26578 | AUDIT | The Teredo IPv6 transition technology will be disabled."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\TCPIP\v6Transition /v Teredo_State
  register: Teredo_audit
  check_mode: no
  changed_when: no
  failed_when: "Teredo_audit.stderr and reg_not_found not in Teredo_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-26578

- name: "MEDIUM | V-26578 | PATCH | The Teredo IPv6 transition technology will be disabled."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\TCPIP\v6Transition'
      value: Teredo_State
      data: Disabled
      datatype: string
  tags:
      - cat2
      - medium
      - patch
      - V-26578

- name: "MEDIUM | V-26579 | AUDIT | The Application event log must be configured to a minimum size requirement."
  win_command: reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\EventLog\Application /v MaxSize
  register: application_log_max_size_audit
  check_mode: no
  changed_when: no
  failed_when: "application_log_max_size_audit.stderr and reg_not_found not in application_log_max_size_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-26579

- name: "MEDIUM | V-26579 | PATCH | The Application event log must be configured to a minimum size requirement."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\Application'
      value: MaxSize
      data: 0x00008000
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-26579

- name: "MEDIUM | V-26580 | AUDIT | The Security event log must be configured to a minimum size requirement."
  win_command: reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\EventLog\Security /v MaxSize
  register: security_log_max_size_audit
  check_mode: no
  changed_when: no
  failed_when: "security_log_max_size_audit.stderr and reg_not_found not in security_log_max_size_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-26580

- name: "MEDIUM | V-26580 | PATCH | The Security event log must be configured to a minimum size requirement."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\Security'
      value: MaxSize
      data: 0x00030000
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-26580

- name: "MEDIUM | V-26581 | AUDIT | The Setup event log must be configured to a minimum size requirement."
  win_command: reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\EventLog\Setup /v MaxSize
  register: setup_log_max_size_audit
  check_mode: no
  changed_when: no
  failed_when: "setup_log_max_size_audit.stderr and reg_not_found not in setup_log_max_size_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-26581

- name: "MEDIUM | V-26581 | PATCH | The Setup event log must be configured to a minimum size requirement."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\Setup'
      value: MaxSize
      data: 0x00008000
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-26581

- name: "MEDIUM | V-26582 | AUDIT | The System event log must be configured to a minimum size requirement."
  win_command: reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\EventLog\System /v MaxSize
  register: system_log_max_size_audit
  check_mode: no
  changed_when: no
  failed_when: "system_log_max_size_audit.stderr and reg_not_found not in system_log_max_size_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-26582

- name: "MEDIUM | V-26582 | PATCH | The System event log must be configured to a minimum size requirement."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\EventLog\System'
      value: MaxSize
      data: 0x00008000
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-26582

- name: "MEDIUM | V-26600 | AUDIT | The Fax service will be disabled."
  win_shell: Get-Service -name fax
  register: fax_service_audit
  check_mode: no
  changed_when: no
  failed_when: "fax_service_audit.stderr and service_not_found not in fax_service_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-26600

- name: "MEDIUM | V-26600 | PATCH | The Fax service will be disabled."
  win_service:
      name: fax
      start_mode: disabled
      state: stopped
  when: not fax_service_audit.stderr
  tags:
      - cat2
      - medium
      - patch
      - V-26600

- name: "MEDIUM | V-26602 | AUDIT | The Microsoft FTP service will be disabled."
  win_shell: Get-Service -name *ftpsvc
  register: ftp_service_audit
  check_mode: no
  changed_when: no
  failed_when: "ftp_service_audit.stderr and service_not_found not in ftp_service_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-26602

- name: "MEDIUM | V-26604 | AUDIT | The Peer Networking Identity Manager service will be disabled."
  win_shell: Get-Service -name p2pimsvc
  register: p2p_service_audit
  check_mode: no
  changed_when: no
  failed_when: "p2p_service_audit.stderr and service_not_found not in p2p_service_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-26604

- name: "MEDIUM | V-26604 | PATCH | The Peer Networking Identity Manager service will be disabled."
  win_service:
      name: p2pimsvc
      start_mode: disabled
      state: stopped
  when: not p2p_service_audit.stderr
  tags:
      - cat2
      - medium
      - patch
      - V-26604

- name: "MEDIUM | V-26605 | AUDIT | The Simple TCP/IP Services service will be disabled."
  win_shell: Get-Service -name simptcp
  register: simtcp_service_audit
  check_mode: no
  changed_when: no
  failed_when: "simtcp_service_audit.stderr and service_not_found not in simtcp_service_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-26605

- name: "MEDIUM | V-26605 | PATCH | The Simple TCP/IP Services service will be disabled."
  win_service:
      name: simptcp
      start_mode: disabled
      state: stopped
  when: not simtcp_service_audit.stderr
  tags:
      - cat2
      - medium
      - patch
      - V-26605

- name: "MEDIUM | V-26606 | AUDIT | The Telnet service will be disabled."
  win_shell: Get-Service -name tlntsvr
  register: telnet_service_audit
  check_mode: no
  changed_when: no
  failed_when: "telnet_service_audit.stderr and service_not_found not in telnet_service_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-26606

- name: "MEDIUM | V-26606 | PATCH | The Telnet service will be disabled."
  win_service:
      name: tlntsvr
      start_mode: disabled
      state: stopped
  when: not telnet_service_audit.stderr
  tags:
      - cat2
      - medium
      - patch
      - V-26606

- name: "MEDIUM | V-32272 | AUDIT | The DoD root certificate must be installed into the Trusted Root Store."
  win_shell: Get-ChildItem -Path cert:\LocalMachine\Root -Recurse | Select-Object -Property FriendlyName,Thumbprint,SignatureAlgorithm | ForEach-Object -Process {"`n"; $_.FriendlyName; $_.Thumbprint; $_.SignatureAlgorithm.FriendlyName}
  register: root_certificate_trustedstore_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-32272

#- name: "MEDIUM | V-32272 | PATCH | The DoD root certificate must be installed into the Trusted Root Store."
#  win_command: true
#  tags:
#      - cat2
#      - medium
#      - patch
#      - V-32272

- name: "MEDIUM | V-32274 | AUDIT | The DoD Interoperability Root CA 1 to DoD Root CA 2 cross-certificate must be installed into the Untrusted Certificates Store."
  win_shell: Get-ChildItem -Path cert:\LocalMachine\Disallowed -Recurse | Select-Object -Property FriendlyName,Thumbprint,SignatureAlgorithm | ForEach-Object -Process {"`n"; $_.FriendlyName; $_.Thumbprint; $_.SignatureAlgorithm.FriendlyName}
  register: root_certificate_untrustedstore_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-32274

#- name: "MEDIUM | V-32274 | PATCH | The DoD Interoperability Root CA 1 to DoD Root CA 2 cross-certificate must be installed into the Untrusted Certificates Store."
#  win_command: true
#  tags:
#      - cat2
#      - medium
#      - patch
#      - V-32274

- name: "MEDIUM | V-36439 | AUDIT | Local administrator accounts must have their privileged token filtered to prevent elevated privileges from being used over the network on domain systems."
  win_command: reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy
  register: token_filter_audit
  check_mode: no
  changed_when: no
  failed_when: "token_filter_audit.stderr and reg_not_found not in token_filter_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36439

- name: "MEDIUM | V-36439 | PATCH | Local administrator accounts must have their privileged token filtered to prevent elevated privileges from being used over the network on domain systems."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System'
      value: LocalAccountTokenFilterPolicy
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36439

- name: "MEDIUM | V-36656 | AUDIT | A screen saver must be enabled on the system."
  win_command: reg query \"HKCU\Software\Policies\Microsoft\Windows\Control Panel\Desktop\" /v ScreenSaveActive
  register: screen_saver_enabled_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in screen_saver_enabled_audit.stderr and screen_saver_enabled_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36656

- name: "MEDIUM | V-36656 | PATCH | A screen saver must be enabled on the system."
  win_regedit:
      key: 'HKCU:\Software\Policies\Microsoft\Windows\Control Panel\Desktop\'
      value: ScreenSaveActive
      data: 1
      datatype: string
  tags:
      - cat2
      - medium
      - patch
      - V-36656

- name: "MEDIUM | V-36657 | AUDIT | The screen saver must be password protected."
  win_command: reg query \"HKCU\Software\Policies\Microsoft\Windows\Control Panel\Desktop\" /v ScreenSaverIsSecure
  register: screen_saver_secure_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in screen_saver_secure_audit.stderr and screen_saver_secure_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36657

- name: "MEDIUM | V-36657 | PATCH | The screen saver must be password protected."
  win_regedit:
      key: 'HKCU:\Software\Policies\Microsoft\Windows\Control Panel\Desktop\'
      value: ScreenSaverIsSecure
      data: 1
      datatype: string
  tags:
      - cat2
      - medium
      - patch
      - V-36657

- name: "MEDIUM | V-36667 | AUDIT | The system must be configured to audit Object Access - Removable Storage failures."
  win_shell: "AuditPol /get /subcategory:'Removable Storage'"
  register: removable_storage_failures_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-36667

- name: "MEDIUM | V-36667 | PATCH | The system must be configured to audit Object Access - Removable Storage failures."
  win_shell: AuditPol /set /subcategory:"Removable Storage" /failure:enable
  when: "'Failure' not in removable_storage_failures_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-36667

- name: "MEDIUM | V-36668 | AUDIT | The system must be configured to audit Object Access - Removable Storage successes."
  win_shell: "AuditPol /get /subcategory:'Removable Storage'"
  register: removable_storage_successes_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-36668

- name: "MEDIUM | V-36668 | PATCH | The system must be configured to audit Object Access - Removable Storage successes."
  win_shell: AuditPol /set /subcategory:"Removable Storage" /success:enable
  when: "'Success' not in removable_storage_successes_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-36668

- name: "MEDIUM | V-36679 | AUDIT | Early Launch Antimalware, Boot-Start Driver Initialization Policy must be enabled and configured to only Good and Unknown."
  win_command: reg query HKLM\System\CurrentControlSet\Policies\EarlyLaunch\ /v DriverLoadPolicy
  register: early_initialization_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in early_initialization_audit.stderr and early_initialization_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36679

- name: "MEDIUM | V-36679 | PATCH | Early Launch Antimalware, Boot-Start Driver Initialization Policy must be enabled and configured to only Good and Unknown."
  win_regedit:
      key: 'HKLM:\System\CurrentControlSet\Policies\EarlyLaunch\'
      value: DriverLoadPolicy
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36679

- name: "MEDIUM | V-36680 | AUDIT | Access to the Windows Store must be turned off."
  win_command: reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Explorer\ /v NoUseStoreOpenWith
  register: windows_store_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in windows_store_audit.stderr and windows_store_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36680

- name: "MEDIUM | V-36680 | PATCH | Access to the Windows Store must be turned off."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Explorer\'
      value: NoUseStoreOpenWith
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36680

- name: "MEDIUM | V-36681 | AUDIT | Copying of user input methods to the system account for sign-in must be prevented."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Control Panel\International\" /v BlockUserInputMethodsForSignIn
  register: copy_user_system_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in copy_user_system_audit.stderr and copy_user_system_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36681

- name: "MEDIUM | V-36681 | PATCH | Copying of user input methods to the system account for sign-in must be prevented."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Control Panel\International\'
      value: BlockUserInputMethodsForSignIn
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36681

- name: "MEDIUM | V-36684 | AUDIT | Local users on domain-joined computers must not be enumerated."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\System\ /v EnumerateLocalUsers
  register: local_domain_joined_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in local_domain_joined_audit.stderr and local_domain_joined_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36684

- name: "MEDIUM | V-36684 | PATCH | Local users on domain-joined computers must not be enumerated."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\System\'
      value: EnumerateLocalUsers
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36684

- name: "MEDIUM | V-36687 | AUDIT | App notifications on the lock screen must be turned off."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\System\ /v DisableLockScreenAppNotifications
  register: app_notifications_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in app_notifications_audit.stderr and app_notifications_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36687

- name: "MEDIUM | V-36687 | PATCH | App notifications on the lock screen must be turned off."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\System\'
      value: DisableLockScreenAppNotifications
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36687

- name: "MEDIUM | V-36698 | AUDIT | The use of biometrics must be disabled."
  win_command: reg query HKLM\SOFTWARE\Policies\Microsoft\Biometrics\ /v Enabled
  register: biometrics_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in biometrics_audit.stderr and biometrics_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36698

- name: "MEDIUM | V-36698 | PATCH | The use of biometrics must be disabled."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Biometrics\'
      value: Enabled
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36698

- name: "MEDIUM | V-36700 | AUDIT | The password reveal button must not be displayed."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\CredUI\ /v DisablePasswordReveal
  register: password_reveal_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in password_reveal_audit.stderr and password_reveal_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36700

- name: "MEDIUM | V-36700 | PATCH | The password reveal button must not be displayed."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\CredUI\'
      value: DisablePasswordReveal
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36700

- name: "MEDIUM | V-36708 | AUDIT | The location feature must be turned off."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\LocationAndSensors\ /v DisableLocation
  register: location_feature_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in location_feature_audit.stderr and location_feature_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36708

- name: "MEDIUM | V-36708 | PATCH | The location feature must be turned off."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\LocationAndSensors\'
      value: DisableLocation
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36708

- name: "MEDIUM | V-36709 | AUDIT | Basic authentication for RSS feeds over HTTP must be turned off."
  win_command: reg query \"HKLM\Software\Policies\Microsoft\Internet Explorer\Feeds\" /v AllowBasicAuthInClear
  register: authentication_rss_http_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in authentication_rss_http_audit.stderr and authentication_rss_http_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36709

- name: "MEDIUM | V-36709 | PATCH | Basic authentication for RSS feeds over HTTP must be turned off."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Internet Explorer\Feeds\'
      value: AllowBasicAuthInClear
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36709

- name: "MEDIUM | V-36711 | AUDIT | The Windows Store application must be turned off."
  win_command: reg query HKLM\SOFTWARE\Policies\Microsoft\WindowsStore\ /v RemoveWindowsStore
  register: windows_store_app_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in windows_store_app_audit.stderr and windows_store_app_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36711

- name: "MEDIUM | V-36711 | PATCH | The Windows Store application must be turned off."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\WindowsStore\'
      value: RemoveWindowsStore
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36711

- name: "MEDIUM | V-36713 | AUDIT | The Windows Remote Management (WinRM) client must not allow unencrypted traffic."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\WinRM\Client\ /v AllowUnencryptedTraffic
  register: winrm_unencrypted_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in winrm_unencrypted_audit.stderr and winrm_unencrypted_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36713

- name: "MEDIUM | V-36713 | PATCH | The Windows Remote Management (WinRM) client must not allow unencrypted traffic."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\WinRM\Client\'
      value: AllowUnencryptedTraffic
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36713

- name: "MEDIUM | V-36714 | AUDIT | The Windows Remote Management (WinRM) client must not use Digest authentication."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\WinRM\Client\ /v AllowDigest
  register: winrm_digest_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in winrm_digest_audit.stderr and winrm_digest_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36714

- name: "MEDIUM | V-36714 | PATCH | The Windows Remote Management (WinRM) client must not use Digest authentication."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\WinRM\Client\'
      value: AllowDigest
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36714

- name: "MEDIUM | V-36719 | AUDIT | The Windows Remote Management (WinRM) service must not allow unencrypted traffic."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\WinRM\Service\ /v AllowUnencryptedTraffic
  register: winrm_unencrypted_traffic_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in winrm_unencrypted_traffic_audit.stderr and winrm_unencrypted_traffic_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36719

- name: "MEDIUM | V-36719 | PATCH | The Windows Remote Management (WinRM) service must not allow unencrypted traffic."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\WinRM\Service\'
      value: AllowUnencryptedTraffic
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36719

- name: "MEDIUM | V-36720 | AUDIT | The Windows Remote Management (WinRM) service must not store RunAs credentials."
  win_command: reg query HKLM\Software\Policies\Microsoft\Windows\WinRM\Service\ /v DisableRunAs
  register: winrm_store_runas_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in winrm_store_runas_audit.stderr and winrm_store_runas_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36720

- name: "MEDIUM | V-36720 | PATCH | The Windows Remote Management (WinRM) service must not store RunAs credentials."
  win_regedit:
      key: 'HKLM:\Software\Policies\Microsoft\Windows\WinRM\Service\'
      value: DisableRunAs
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36720

- name: "MEDIUM | V-36722 | AUDIT | Permissions for the Application event log must prevent access by nonprivileged accounts."
  win_shell: Get-Acl -PATH 'C:\WINDOWS\SYSTEM32\WINEVT\LOGS\Application.evtx' | Format-List
  register: eventlog_permissions_audit
  check_mode: no
  changed_when: no
  failed_when: "path_not_found not in eventlog_permissions_audit.stderr and eventlog_permissions_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36722

- name: "MEDIUM | V-36722 | AUDIT | Permissions for the Application event log must prevent access by nonprivileged accounts."
  win_shell: (Get-Acl -PATH 'C:\WINDOWS\SYSTEM32\WINEVT\LOGS\Application.evtx').Access.IdentityReference.Value
  register: eventlog_permissions_audit
  check_mode: no
  changed_when: no
  failed_when: "path_not_found not in eventlog_permissions_audit.stderr and eventlog_permissions_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36722

###################### block start - conditionally apply patches if path exists #########################

- block:
    - name: "REMOVAL MEDIUM | V-36722 | PATCH | Permissions for the Application event log must prevent access by nonprivileged accounts."
      win_acl:
          path: 'C:\WINDOWS\SYSTEM32\WINEVT\LOGS\Application.evtx'
          user: '{{ item[0] | replace("APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES" , "ALL APPLICATION PACKAGES") }}'
          rights: 'FullControl'
          type: '{{ item[1] }}'
          state: 'absent'
      when: "not('EventLog' in item[0] or 'SYSTEM' in item[0] or 'Administrators' in item[0]) or 'allow' not in item[1]"
      with_nested:
          - "{{ eventlog_permissions_audit.stdout_lines }}"
          - [ allow, deny ]
     
    - name: "MEDIUM | V-36722 | PATCH | Permissions for the Application event log must prevent access by nonprivileged accounts."
      win_acl:
          path: 'C:\WINDOWS\SYSTEM32\WINEVT\LOGS\Application.evtx'
          user: '{{ item }}'
          rights: 'FullControl'
          type: 'allow'
          state: 'present'
          inherit: 'ContainerInherit, ObjectInherit'
          propagation: 'None'
      with_items:
          - 'NT SERVICE\EventLog'
          - 'NT AUTHORITY\SYSTEM'
          - 'BUILTIN\Administrators'
   
    - name: "REMOVAL MEDIUM | V-36722 | PATCH | Permissions for the Application event log must prevent access by nonprivileged accounts."
      win_acl_inheritance:
          path: 'C:\WINDOWS\SYSTEM32\WINEVT\LOGS\Application.evtx'
          state: 'absent'
   
  when: "path_not_found not in eventlog_permissions_audit.stderr and eventlog_permissions_audit"
  tags:
      - cat2
      - medium
      - patch
      - V-36722
######################################### block end #####################################################

- name: "MEDIUM | V-36723 | AUDIT | Permissions for the Security event log must prevent access by nonprivileged accounts."
  win_shell: Get-Acl -PATH 'C:\WINDOWS\SYSTEM32\WINEVT\LOGS\Security.evtx' | Format-List
  register: security_evtx_audit
  check_mode: no
  changed_when: no
  failed_when: "path_not_found not in security_evtx_audit.stderr and security_evtx_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36723

- name: "MEDIUM | V-36723 | AUDIT | Permissions for the Security event log must prevent access by nonprivileged accounts."
  win_shell: (Get-Acl -PATH 'C:\WINDOWS\SYSTEM32\WINEVT\LOGS\Security.evtx').Access.IdentityReference.Value
  register: security_evtx_audit
  check_mode: no
  changed_when: no
  failed_when: "path_not_found not in security_evtx_audit.stderr and security_evtx_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36723

###################### block start - conditionally apply patches if path exists #########################

- block:
    - name: "REMOVAL MEDIUM | V-36723 | PATCH | Permissions for the Security event log must prevent access by nonprivileged accounts."
      win_acl:
          path: 'C:\WINDOWS\SYSTEM32\WINEVT\LOGS\Security.evtx'
          user: '{{ item[0] | replace("APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES" , "ALL APPLICATION PACKAGES") }}'
          rights: 'FullControl'
          type: '{{ item[1] }}'
          state: 'absent'
      when: "not('EventLog' in item[0] or 'SYSTEM' in item[0] or 'Administrators' in item[0]) or 'allow' not in item[1]"
      with_nested:
          - "{{ security_evtx_audit.stdout_lines }}"
          - [ allow, deny ]
   
    - name: "MEDIUM | V-36723 | PATCH | Permissions for the Security event log must prevent access by nonprivileged accounts."
      win_acl:
          path: 'C:\WINDOWS\SYSTEM32\WINEVT\LOGS\Security.evtx'
          user: '{{ item }}'
          rights: 'FullControl'
          type: 'allow'
          state: 'present'
          inherit: 'ContainerInherit, ObjectInherit'
          propagation: 'None'
      with_items:
          - 'NT SERVICE\Eventlog'
          - 'NT AUTHORITY\SYSTEM'
          - 'BUILTIN\Administrators'
     
    - name: "REMOVAL MEDIUM | V-36723 | PATCH | Permissions for the Security event log must prevent access by nonprivileged accounts."
      win_acl_inheritance:
          path: 'C:\WINDOWS\SYSTEM32\WINEVT\LOGS\Security.evtx'
          state: 'absent'
     
  when: "path_not_found not in security_evtx_audit.stderr and security_evtx_audit"
  tags:
      - cat2
      - medium
      - patch
      - V-36723
######################################### block end #####################################################

- name: "MEDIUM | V-36724 | AUDIT | Permissions for the System event log must prevent access by nonprivileged accounts."
  win_shell: Get-Acl -PATH 'C:\WINDOWS\SYSTEM32\WINEVT\LOGS\System.evtx' | Format-List
  register: system_evtx_audit
  check_mode: no
  changed_when: no
  failed_when: "path_not_found not in system_evtx_audit.stderr and system_evtx_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36724

- name: "MEDIUM | V-36724 | AUDIT | Permissions for the System event log must prevent access by nonprivileged accounts."
  win_shell: (Get-Acl -PATH 'C:\WINDOWS\SYSTEM32\WINEVT\LOGS\System.evtx').Access.IdentityReference.Value
  register: system_evtx_audit
  check_mode: no
  changed_when: no
  failed_when: "path_not_found not in system_evtx_audit.stderr and system_evtx_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36724

###################### block start - conditionally apply patches if path exists #########################

- block:
    - name: "REMOVAL MEDIUM | V-36724 | PATCH | Permissions for the System event log must prevent access by nonprivileged accounts."
      win_acl:
          path: 'C:\WINDOWS\SYSTEM32\WINEVT\LOGS\System.evtx'
          user: '{{ item[0] | replace("APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES" , "ALL APPLICATION PACKAGES") }}'
          rights: 'FullControl'
          type: '{{ item[1] }}'
          state: 'absent'
      when: "not('EventLog' in item[0] or 'SYSTEM' in item[0] or 'Administrators' in item[0]) or 'allow' not in item[1]"
      with_nested:
          - "{{ system_evtx_audit.stdout_lines }}"
          - [ allow, deny ]
   
    - name: "MEDIUM | V-36724 | PATCH | Permissions for the System event log must prevent access by nonprivileged accounts."
      win_acl:
          path: 'C:\WINDOWS\SYSTEM32\WINEVT\LOGS\System.evtx'
          user: '{{ item }}'
          rights: 'FullControl'
          type: 'allow'
          state: 'present'
          inherit: 'ContainerInherit, ObjectInherit'
          propagation: 'None'
      with_items:
          - 'NT SERVICE\EventLog'
          - 'NT AUTHORITY\SYSTEM'
          - 'BUILTIN\Administrators'
   

    - name: "REMOVAL MEDIUM | V-36724 | PATCH | Permissions for the System event log must prevent access by nonprivileged accounts."
      win_acl_inheritance:
          path: 'C:\WINDOWS\SYSTEM32\WINEVT\LOGS\System.evtx'
          state: 'absent'
   
  when: "path_not_found not in system_evtx_audit.stderr and system_evtx_audit"
  tags:
      - cat2
      - medium
      - patch
      - V-36724
######################################### block end #####################################################

- name: "MEDIUM | V-36773 | AUDIT | The machine inactivity limit must be set to 15 minutes, locking the system with the screensaver."
  win_command: reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System\ /v InactivityTimeoutSecs
  register: inactivity_limit_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in inactivity_limit_audit.stderr and inactivity_limit_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-36773

- name: "MEDIUM | V-36773 | PATCH | The machine inactivity limit must be set to 15 minutes, locking the system with the screensaver."
  win_regedit:
      key: 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System\'
      value: InactivityTimeout
      data: 0x00000384
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-36773

- name: "MEDIUM | V-40177 | AUDIT | Permissions for program file directories must conform to minimum requirements."
  win_shell: Get-Acl -PATH '\Program Files' | Format-List
  register: program_files_minimum_audit
  check_mode: no
  changed_when: no
  failed_when: "path_not_found not in program_files_minimum_audit.stderr and program_files_minimum_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-40177

- name: "MEDIUM | V-40177 | AUDIT | Permissions for program file directories must conform to minimum requirements."
  win_shell: (Get-Acl -PATH '\Program Files').Access.IdentityReference.Value
  register: program_files_minimum_audit
  check_mode: no
  changed_when: no
  failed_when: "path_not_found not in program_files_minimum_audit.stderr and program_files_minimum_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-40177

- name: "MEDIUM | V-40177 | AUDIT | Permissions for program file directories must conform to minimum requirements."
  win_shell: Get-Acl -PATH '\Program Files (x86)' | Format-List
  register: program_filesx86_minimum_audit
  check_mode: no
  changed_when: no
  failed_when: "path_not_found not in program_filesx86_minimum_audit.stderr and program_filesx86_minimum_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-40177

- name: "MEDIUM | V-40177 | AUDIT | Permissions for program file directories must conform to minimum requirements."
  win_shell: (Get-Acl -PATH '\Program Files (x86)').Access.IdentityReference.Value
  register: program_filesx86_minimum_audit
  check_mode: no
  changed_when: no
  failed_when: "path_not_found not in program_filesx86_minimum_audit.stderr and program_filesx86_minimum_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-40177

###################### block start - conditionally apply patches if paths exist #########################

- block:
    - name: "REMOVAL MEDIUM | V-40177 | PATCH | Permissions for program file directories must conform to minimum requirements."
      win_acl:
          path: '\Program Files'
          user: '{{ item[0] | replace("APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES" , "ALL APPLICATION PACKAGES")}}'
          rights: 'FullControl'
          type: '{{ item[1] }}'
          state: 'absent'
      when: "not('TrustedInstaller' in item[0] or 'SYSTEM' in item[0] or 'Administrators' in item[0] or 'CREATOR OWNER' in item[0]) or 'allow' not in item[1]"
      with_nested:
          - '{{ program_files_minimum_audit.stdout_lines }}'
          - [ allow, deny ]
     
    - name: "REMOVAL MEDIUM | V-40177 | PATCH | Permissions for program file directories must conform to minimum requirements."
      win_acl:
          path: '\Program Files (x86)'
          user: '{{ item[0] | replace("APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES" , "ALL APPLICATION PACKAGES")}}'
          rights: 'FullControl'
          type: '{{ item[1] }}'
          state: 'absent'
      when: "not('TrustedInstaller' in item[0] or 'SYSTEM' in item[0] or 'Administrators' in item[0] or 'CREATOR OWNER' in item[0]) or 'allow' not in item[1]"
      with_nested:
          - '{{ program_filesx86_minimum_audit.stdout_lines }}'
          - [ allow, deny ]
   
    - name: "MEDIUM | V-40177 | PATCH | Permissions for program file directories must conform to minimum requirements."
      win_acl:
          path: '\Program Files'
          user: '{{ item.user }}'
          rights: '{{ item.rights }}'
          type: 'allow'
          state: 'present'
          inherit: '{{ item.inherit }}'
          propagation: '{{ item.propagation }}'
      with_items:
          - user: 'NT SERVICE\TrustedInstaller'
            rights: 'FullControl'
            inherit: 'ContainerInherit'
            propagation: 'InheritOnly'
          - user: 'NT AUTHORITY\SYSTEM'
            rights: 'Modify'
            inherit: 'None'
            propagation: 'None'
          - user: 'NT AUTHORITY\SYSTEM'
            rights: 'FullControl'
            inherit: 'ContainerInherit,ObjectInherit'
            propagation: 'InheritOnly'
          - user: 'BUILTIN\Administrators'
            rights: 'Modify'
            inherit: 'None'
            propagation: 'None'
          - user: 'BUILTIN\Administrators'
            rights: 'FullControl'
            inherit: 'ContainerInherit,ObjectInherit'
            propagation: 'InheritOnly'
          - user: 'BUILTIN\Users'
            rights: 'ReadAndExecute'
            inherit: 'ContainerInherit,ObjectInherit'
            propagation: 'None'
          - user: 'CREATOR OWNER'
            rights: 'FullControl'
            inherit: 'ContainerInherit,ObjectInherit'
            propagation: 'InheritOnly'
          - user: 'ALL APPLICATION PACKAGES'
            rights: 'ReadAndExecute'
            inherit: 'ContainerInherit, ObjectInherit'
            propagation: 'None'
   
    - name: "MEDIUM | V-40177 | PATCH | Permissions for program file directories must conform to minimum requirements."
      win_acl:
          path: '\Program Files (x86)'
          user: '{{ item.user }}'
          rights: '{{ item.rights }}'
          type: 'allow'
          state: 'present'
          inherit: '{{ item.inherit }}'
          propagation: '{{ item.propagation }}'
      with_items:
          - user: 'NT SERVICE\TrustedInstaller'
            rights: 'FullControl'
            inherit: 'ContainerInherit'
            propagation: 'InheritOnly'
          - user: 'NT AUTHORITY\SYSTEM'
            rights: 'Modify'
            inherit: 'None'
            propagation: 'None'
          - user: 'NT AUTHORITY\SYSTEM'
            rights: 'FullControl'
            inherit: 'ContainerInherit,ObjectInherit'
            propagation: 'InheritOnly'
          - user: 'BUILTIN\Administrators'
            rights: 'Modify'
            inherit: 'None'
            propagation: 'None'
          - user: 'BUILTIN\Administrators'
            rights: 'FullControl'
            inherit: 'ContainerInherit,ObjectInherit'
            propagation: 'InheritOnly'
          - user: 'BUILTIN\Users'
            rights: 'ReadAndExecute'
            inherit: 'ContainerInherit,ObjectInherit'
            propagation: 'None'
          - user: 'CREATOR OWNER'
            rights: 'FullControl'
            inherit: 'ContainerInherit,ObjectInherit'
            propagation: 'InheritOnly'
          - user: 'ALL APPLICATION PACKAGES'
            rights: 'ReadAndExecute'
            inherit: 'ContainerInherit, ObjectInherit'
            propagation: 'None'
   
    - name: "REMOVAL MEDIUM | V-40177 | PATCH | Permissions for program file directories must conform to minimum requirements."
      win_acl_inheritance:
          path: '{{ item }}'
          state: absent
      with_items:
          - '\Program Files'
          - '\Program Files (x86)'
   
  when: "path_not_found not in (program_files_minimum_audit.stderr and program_filesx86_minimum_audit.stderr) and program_files_minimum_audit and program_filesx86_minimum_audit"
  tags:
      - cat2
      - medium
      - patch
      - V-40177
######################################### block end #####################################################

- name: "MEDIUM | V-40178 | AUDIT | Permissions for system drive root directory must conform to minimum requirements."
  win_shell: Get-Acl -PATH 'C:' | Format-List
  register: root_permissions_audit
  check_mode: no
  changed_when: no
  failed_when: "path_not_found not in root_permissions_audit.stderr and root_permissions_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-40178

- name: "MEDIUM | V-40178 | AUDIT | Permissions for system drive root directory must conform to minimum requirements."
  win_shell: (Get-Acl -PATH 'C:').Access.IdentityReference.Value
  register: root_permissions_audit
  check_mode: no
  changed_when: no
  failed_when: "path_not_found not in root_permissions_audit.stderr and root_permissions_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-40178

###################### block start - conditionally apply patches if paths exist #########################

- block:
    - name: "REMOVAL MEDIUM | V-40178 | PATCH | Permissions for system drive root directory must conform to minimum requirements."
      win_acl:
          path: 'C:'
          user: '{{ item[0] | replace("APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES" , "ALL APPLICATION PACKAGES")}}'
          rights: 'FullControl'
          type: '{{ item[1] }}'
          state: 'absent'
      when: "not('SYSTEM' in item[0] or 'Administrators' in item[0] or 'CREATOR OWNER' in item[0]) or 'allow' not in item[1]"
      with_nested:
          - '{{ root_permissions_audit.stdout_lines }}'
          - [ allow, deny ]
   
    - name: "MEDIUM | V-40178 | PATCH | Permissions for system drive root directory must conform to minimum requirements."
      win_acl:
          path: 'C:'
          user: '{{ item.user }}'
          rights: '{{ item.rights }}'
          type: 'allow'
          state: 'present'
          inherit: '{{ item.inherit }}'
          propagation: '{{ item.propagation }}'
      with_items:
          - user: 'NT AUTHORITY\SYSTEM'
            rights: 'FullControl'
            inherit: 'ContainerInherit,ObjectInherit'
            propagation: 'None'
          - user: 'BUILTIN\Administrators'
            rights: 'FullControl'
            inherit: 'ContainerInherit,ObjectInherit'
            propagation: 'None'
          - user: 'BUILTIN\Users'
            rights: 'ReadAndExecute'
            inherit: 'ContainerInherit,ObjectInherit'
            propagation: 'None'
          - user: 'BUILTIN\Users'
            rights: 'AppendData'
            inherit: 'ContainerInherit'
            propagation: 'None'
          - user: 'BUILTIN\Users'
            rights: 'CreateFiles,WriteData'
            inherit: 'ContainerInherit'
            propagation: 'InheritOnly'
          - user: 'CREATOR OWNER'
            rights: 'FullControl'
            inherit: 'ContainerInherit,ObjectInherit'
            propagation: 'InheritOnly'
   
    - name: "MEDIUM | V-40178 | PATCH | Permissions for system drive root directory must conform to minimum requirements."
      win_acl_inheritance:
          path: 'C:'
          state: 'absent'
   
  when: "path_not_found not in root_permissions_audit.stderr and root_permissions_audit"
  tags:
      - cat2
      - medium
      - patch
      - V-40178
######################################### block end #####################################################

- name: "MEDIUM | V-40179 | AUDIT | Permissions for Windows installation directory must conform to minimum requirements."
  win_command: reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion /v ProgramFilesDir
  register: windows_installation_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in windows_installation_audit.stderr and windows_installation_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-40179

- name: "MEDIUM | V-40179 | AUDIT | Permissions for Windows installation directory must conform to minimum requirements."
  win_shell: (Get-Acl -PATH 'C:\Windows').Access.IdentityReference.Value
  register: windows_installation_audit
  check_mode: no
  changed_when: no
  failed_when: "path_not_found not in windows_installation_audit.stderr and windows_installation_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-40179

###################### block start - conditionally apply patches if path exists #########################

- block:
    - name: "REMOVAL MEDIUM | V-40179 | PATCH | Permissions for Windows installation directory must conform to minimum requirements."
      win_acl:
          path: 'C:\Windows'
          user: '{{ item[0] | replace("APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES" , "ALL APPLICATION PACKAGES") }}'
          rights: 'FullControl'
          type: '{{ item[1] }}'
          state: 'absent'
      when: "not('TrustedInstaller' in item[0] or 'SYSTEM' in item[0] or 'Administrators' in item[0] or 'CREATOR OWNER' in item[0]) or 'allow' not in item[1]"
      with_nested:
          - "{{ windows_installation_audit.stdout_lines }}"
          - [ allow, deny ]
   
    - name: "MEDIUM | V-40179 | PATCH | Permissions for Windows installation directory must conform to minimum requirements."
      win_acl:
          path: 'C:\Windows'
          user: '{{ item.user }}'
          rights: '{{ item.rights }}'
          type: 'allow'
          state: 'present'
          inherit: '{{ item.inherit }}'
          propagation: '{{ item.propagation }}'
      with_items:
          - user: 'NT SERVICE\TrustedInstaller'
            rights: 'FullControl'
            inherit: 'ContainerInherit'
            propagation: 'None'
          - user: 'NT AUTHORITY\SYSTEM'
            rights: 'Modify'
            inherit: 'None'
            propagation: 'None'
          - user: 'NT AUTHORITY\SYSTEM'
            rights: 'FullControl'
            inherit: 'ContainerInherit,ObjectInherit'
            propagation: 'InheritOnly'
          - user: 'BUILTIN\Administrators'
            rights: 'Modify'
            inherit: 'None'
            propagation: 'None'
          - user: 'BUILTIN\Administrators'
            rights: 'FullControl'
            inherit: 'ContainerInherit,ObjectInherit'
            propagation: 'InheritOnly'
          - user: 'CREATOR OWNER'
            rights: 'FullControl'
            inherit: 'ContainerInherit,ObjectInherit'
            propagation: 'InheritOnly'
          - user: 'ALL APPLICATION PACKAGES'
            rights: 'FullControl'
            inherit: 'ContainerInherit,ObjectInherit'
            propagation: 'None'
   
    - name: "REMOVAL MEDIUM | V-40179 | PATCH | Permissions for Windows installation directory must conform to minimum requirements."
      win_acl_inheritance:
          path: 'C:\Windows'
          state: 'absent'
   
  when: "path_not_found not in windows_installation_audit.stderr and windows_installation_audit"
  tags:
      - cat2
      - medium
      - patch
      - V-40179
######################################### block end #####################################################

- name: "MEDIUM | V-40200 | AUDIT | The system must be configured to audit Object Access - Central Access Policy Staging failures."
  win_shell: "AuditPol /get /subcategory:'Central Policy Staging'"
  register: central_access_failure_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-40200

- name: "MEDIUM | V-40200 | PATCH | The system must be configured to audit Object Access - Central Access Policy Staging failures."
  win_shell: AuditPol /set /subcategory:"Central Policy Staging" /failure:enable
  when: "'Failure' not in central_access_failure_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-40200

- name: "MEDIUM | V-40202 | AUDIT | The system must be configured to audit Object Access - Central Access Policy Staging successes."
  win_shell: "AuditPol /get /subcategory:'Central Policy Staging'"
  register: central_access_success_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-40202

- name: "MEDIUM | V-40202 | PATCH | The system must be configured to audit Object Access - Central Access Policy Staging successes."
  win_shell: AuditPol /set /subcategory:"Central Policy Staging" /success:enable
  when: "'Success' not in central_access_success_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-40202

- name: "MEDIUM | V-43238 | AUDIT | The display of slide shows on the lock screen must be disabled (Windows 2012 R2)."
  win_command: reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Personalization\ /v NoLockScreenSlideshow
  register: display_lock_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in display_lock_audit.stderr and display_lock_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-43238

- name: "MEDIUM | V-43238 | PATCH | The display of slide shows on the lock screen must be disabled (Windows 2012 R2)."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Personalization\'
      value: NoLockScreenSlideshow
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-43238

- name: "MEDIUM | V-43239 | AUDIT | Command line data must be prevented from inclusion in process creation events (Windows 2012 R2)."
  win_command: reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit\ /v ProcessCreationIncludeCmdLine_Enabled
  register: prevented_process_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in prevented_process_audit.stderr and prevented_process_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-43239

- name: "MEDIUM | V-43239 | PATCH | Command line data must be prevented from inclusion in process creation events (Windows 2012 R2)."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit\'
      value: ProcessCreationIncludeCmdLine_Enabled
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-43239

- name: "MEDIUM | V-43240 | AUDIT | The network selection user interface (UI) must not be displayed on the logon screen (Windows 2012 R2)."
  win_command: reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\System\ /v DontDisplayNetworkSelectionUI
  register: network_selection_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in network_selection_audit.stderr and network_selection_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-43240

- name: "MEDIUM | V-43240 | PATCH | The network selection user interface (UI) must not be displayed on the logon screen (Windows 2012 R2)."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\System\'
      value: DontDisplayNetworkSelectionUI
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-43240

- name: "MEDIUM | V-43245 | AUDIT | Automatically signing in the last interactive user after a system-initiated restart must be disabled (Windows 2012 R2)."
  win_command: reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\ /v DisableAutomaticRestartSignOn
  register: automatic_restart_signin_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in automatic_restart_signin_audit.stderr and automatic_restart_signin_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-43245

- name: "MEDIUM | V-43245 | PATCH | Automatically signing in the last interactive user after a system-initiated restart must be disabled (Windows 2012 R2)."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\'
      value: DontDisplayNetworkSelectionUI
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-43245

- name: "MEDIUM | V-56511 | AUDIT | The Windows Error Reporting Service must be running and configured to start automatically."
  win_shell: Get-Service -name WerSvc
  register: WER_service_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-56511

- name: "MEDIUM | V-56511 | PATCH | The Windows Error Reporting Service must be running and configured to start automatically."
  win_service:
      name: WerSvc
      start_mode: auto
      state: started
  tags:
      - cat2
      - medium
      - patch
      - V-56511

- name: "MEDIUM | V-57453 | AUDIT | The system must be configured to collect multiple error reports of the same event type."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v BypassDataThrottling
  register: multiple_error_reports_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in multiple_error_reports_audit.stderr and multiple_error_reports_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57453

- name: "MEDIUM | V-57453 | PATCH | The system must be configured to collect multiple error reports of the same event type."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\'
      value: BypassDataThrottling
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57453

- name: "MEDIUM | V-57455 | AUDIT | The system must be configured to prevent the display of error messages to the user."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v DontShowUI
  register: error_message_audit
  check_mode: no
  changed_when: no
  failed_when: "error_message_audit.stderr and reg_not_found not in error_message_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57455

- name: "MEDIUM | V-57455 | PATCH | The system must be configured to prevent the display of error messages to the user."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: DontShowUI
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57455

- name: "MEDIUM | V-57457 | AUDIT | The system must be configured to store error reports locally, on the system or in the enclave, and not send them to Microsoft."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v CorporateWerServer
  register: error_message_audit
  check_mode: no
  changed_when: no
  failed_when: "error_message_audit.stderr and reg_not_found not in error_message_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57457

# Only make the data " " if there isn't a value. Existing values should be error reporting server hostname or IP.
- name: "MEDIUM | V-57457 | PATCH | The system must be configured to store error reports locally, on the system or in the enclave, and not send them to Microsoft."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: CorporateWerServer
      data: " "
      datatype: string
  when: not error_message_audit.stdout
  tags:
      - cat2
      - medium
      - patch
      - V-57457

# Need to recheck if WER is being used first. Skip the rest if WER is not configured.
- name: "MEDIUM | V-57459 | AUDIT | The system must be configured to use SSL to forward error reports."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v CorporateWerServer
  register: error_message_audit
  check_mode: no
  changed_when: no
  failed_when: "error_message_audit.stderr and reg_not_found not in error_message_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57459

# Only run when WER server isn't blank
- name: "MEDIUM | V-57459 | PATCH | The system must be configured to use SSL to forward error reports."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: CorporateWerUseSSL
      data: 1
      datatype: dword
  when: "'CorporateWerServer    REG_SZ     \\r' not in error_message_audit.stdout and reg_not_found not in error_message_audit.stderr"
  tags:
      - cat2
      - medium
      - patch
      - V-57459

# Need to recheck if WER is being used first. Skip the rest if WER is not configured.
- name: "MEDIUM | V-57461 | AUDIT | The system must be configured to send error reports on TCP port 1232."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v CorporateWerServer
  register: error_message_audit
  check_mode: no
  changed_when: no
  failed_when: "error_message_audit.stderr and reg_not_found not in error_message_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57461

# Only run when WER server isn't blank
- name: "MEDIUM | V-57461 | AUDIT | The system must be configured to send error reports on TCP port 1232."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v CorporateWerPortNumber
  register: error_message_port_audit
  check_mode: no
  changed_when: no
  failed_when: "error_message_port_audit.stderr and reg_not_found not in error_message_port_audit.stderr"
  when: "'CorporateWerServer    REG_SZ     \\r' not in error_message_audit.stdout and reg_not_found not in error_message_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57461

# Only run when WER server isn't blank
- name: "MEDIUM | V-57461 | PATCH | The system must be configured to send error reports on TCP port 1232."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: CorporateWerPortNumber
      data: 0x000004d0
      datatype: dword
  when: "'CorporateWerServer    REG_SZ     \\r' not in error_message_audit.stdout and reg_not_found not in error_message_audit.stderr"
  tags:
      - cat2
      - medium
      - patch
      - V-57461

- name: "MEDIUM | V-57463 | AUDIT | The system must be configured to archive error reports."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v DisableArchive
  register: disable_archive_audit
  check_mode: no
  changed_when: no
  failed_when: "disable_archive_audit.stderr and reg_not_found not in disable_archive_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57463

- name: "MEDIUM | V-57463 | PATCH | The system must be configured to archive error reports."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: DisableArchive
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57463

- name: "MEDIUM | V-57465 | AUDIT | The system must be configured to store all data in the error report archive."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v ConfigureArchive
  register: archive_error_reports_audit
  check_mode: no
  changed_when: no
  failed_when: "archive_error_reports_audit.stderr and reg_not_found not in archive_error_reports_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57465

- name: "MEDIUM | V-57465 | PATCH | The system must be configured to store all data in the error report archive."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: ConfigureArchive
      data: 0x00000002
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57465

- name: "MEDIUM | V-57467 | AUDIT | The maximum number of error reports to archive on a system must be configured to 100 or greater."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v MaxArchiveCount
  register: max_achive_count_audit
  check_mode: no
  changed_when: no
  failed_when: "max_achive_count_audit.stderr and reg_not_found not in max_achive_count_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57467

- name: "MEDIUM | V-57467 | PATCH | The maximum number of error reports to archive on a system must be configured to 100 or greater."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: MaxArchiveCount
      data: 0x00000064
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57467

- name: "MEDIUM | V-57469 | AUDIT | The system must be configured to queue error reports until a local or DOD-wide collector is available."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v DisableQueue
  register: disable_queue_audit
  check_mode: no
  changed_when: no
  failed_when: "disable_queue_audit.stderr and reg_not_found not in disable_queue_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57469

- name: "MEDIUM | V-57469 | PATCH | The system must be configured to queue error reports until a local or DOD-wide collector is available."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: DisableQueue
      data: 0
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57469

- name: "MEDIUM | V-57471 | AUDIT | The system must be configured to add all error reports to the queue."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v ForceQueue
  register: force_queue_audit
  check_mode: no
  changed_when: no
  failed_when: "force_queue_audit.stderr and reg_not_found not in force_queue_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57471

- name: "MEDIUM | V-57471 | PATCH | The system must be configured to add all error reports to the queue."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: ForceQueue
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57471

- name: "MEDIUM | V-57473 | AUDIT | The maximum number of error reports to queue on a system must be configured to 50 or greater."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v MaxQueueCount
  register: max_queue_audit
  check_mode: no
  changed_when: no
  failed_when: "max_queue_audit.stderr and reg_not_found not in max_queue_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57473

- name: "MEDIUM | V-57473 | PATCH | The maximum number of error reports to queue on a system must be configured to 50 or greater."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: MaxQueueCount
      data: 0x00000032
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57473

- name: "MEDIUM | V-57475 | AUDIT | The system must be configured to attempt to forward queued error reports once a day."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\" /v QueuePesterInterval
  register: daily_forward_audit
  check_mode: no
  changed_when: no
  failed_when: "daily_forward_audit.stderr and reg_not_found not in daily_forward_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57475

- name: "MEDIUM | V-57475 | PATCH | The system must be configured to attempt to forward queued error reports once a day."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting'
      value: QueuePesterInterval
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57475

- name: "MEDIUM | V-57477 | AUDIT | The system must be configured to automatically consent to send all data requested by a local or DOD-wide error collection site."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\Consent\" /v DefaultConsent
  register: default_consent_audit
  check_mode: no
  changed_when: no
  failed_when: "default_consent_audit.stderr and reg_not_found not in default_consent_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57477

- name: "MEDIUM | V-57477 | PATCH | The system must be configured to automatically consent to send all data requested by a local or DOD-wide error collection site."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\Consent'
      value: DefaultConsent
      data: 0x00000004
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57477

- name: "MEDIUM | V-57479 | AUDIT | The system must be configured to permit the default consent levels of Windows Error Reporting to override any other consent policy setting."
  win_command: reg query \"HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\Consent\" /v DefaultOverrideBehavior
  register: override_audit
  check_mode: no
  changed_when: no
  failed_when: "override_audit.stderr and reg_not_found not in override_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57479

- name: "MEDIUM | V-57479 | PATCH | The system must be configured to permit the default consent levels of Windows Error Reporting to override any other consent policy setting."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Error Reporting\Consent'
      value: DefaultOverrideBehavior
      data: 1
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57479

- name: "MEDIUM | V-57633 | AUDIT | The system must be configured to audit Policy Change - Authorization Policy Change successes."
  win_shell: "AuditPol /get /subcategory:'Authorization Policy Change'"
  register: auth_policy_successes_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-57633

- name: "MEDIUM | V-57633 | PATCH | The system must be configured to audit Policy Change - Authorization Policy Change successes."
  win_shell: AuditPol /set /subcategory:"Authorization Policy Change" /success:enable
  when: "'Success' not in auth_policy_successes_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-57633

- name: "MEDIUM | V-57635 | AUDIT | The system must be configured to audit Policy Change - Authorization Policy Change failures."
  win_shell: "AuditPol /get /subcategory:'Authorization Policy Change'"
  register: auth_policy_failures_audit
  check_mode: no
  changed_when: no
  tags:
      - cat2
      - medium
      - audit
      - V-57635

- name: "MEDIUM | V-57635 | PATCH | The system must be configured to audit Policy Change - Authorization Policy Change failures."
  win_shell: AuditPol /set /subcategory:"Authorization Policy Change" /failure:enable
  when: "'Failure' not in auth_policy_failures_audit.stdout"
  tags:
      - cat2
      - medium
      - patch
      - V-57635

- name: "MEDIUM | V-57639 | AUDIT | Users must be required to enter a password to access private keys stored on the computer."
  win_command: reg query HKLM\SOFTWARE\Policies\Microsoft\Cryptography\ /v ForceKeyProtection
  register: password_private_audit
  check_mode: no
  changed_when: no
  failed_when: "reg_not_found not in password_private_audit.stderr and password_private_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57639

- name: "MEDIUM | V-57639 | PATCH | Users must be required to enter a password to access private keys stored on the computer."
  win_regedit:
      key: 'HKLM:\SOFTWARE\Policies\Microsoft\Cryptography\'
      value: ForceKeyProtection
      data: 2
      datatype: dword
  tags:
      - cat2
      - medium
      - patch
      - V-57639

- name: "MEDIUM | V-57721 | AUDIT | Event Viewer must be protected from unauthorized modification and deletion."
  win_shell: Get-Acl -PATH 'C:\Windows\System32\Eventvwr.exe' | Format-List
  register: event_viewer_audit
  check_mode: no
  changed_when: no
  failed_when: "path_not_found not in event_viewer_audit.stderr and event_viewer_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57721

- name: "MEDIUM | V-57721 | AUDIT | Event Viewer must be protected from unauthorized modification and deletion."
  win_shell: (Get-Acl -PATH 'C:\Windows\System32\Eventvwr.exe').Access.IdentityReference.Value
  register: event_viewer_audit
  check_mode: no
  changed_when: no
  failed_when: "path_not_found not in event_viewer_audit.stderr and event_viewer_audit.stderr"
  tags:
      - cat2
      - medium
      - audit
      - V-57721

###################### block start - conditionally apply patches if path exists #########################

- block:
    - name: "MEDIUM | V-57721 | PATCH | Event Viewer must be protected from unauthorized modification and deletion."
      win_acl:
          path: 'C:\Windows\System32\Eventvwr.exe'
          user: '{{ item[0] | replace("APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES" , "ALL APPLICATION PACKAGES") }}'
          rights: 'FullControl'
          type: '{{ item[1] }}'
          state: 'absent'
      when: "not('TrustedInstaller' in item[0] or 'Administrators' in item[0]) or 'allow' not in item[1]"
      with_nested:
          - "{{ event_viewer_audit.stdout_lines }}"
          - [ allow, deny ]
     
    - name: "MEDIUM | V-57721 | PATCH | Event Viewer must be protected from unauthorized modification and deletion."
      win_acl:
          path: 'C:\Windows\System32\Eventvwr.exe'
          user: '{{ item.user }}'
          rights: '{{ item.rights }}'
          type: 'allow'
          state: 'present'
          inherit: '{{ item.inherit }}'
          propagation: '{{ item.propagation }}'
      with_items:
          - user: 'NT SERVICE\TrustedInstaller'
            rights: 'FullControl'
            inherit: 'None'
            propagation: 'None'
          - user: 'NT AUTHORITY\SYSTEM'
            rights: 'ReadAndExecute'
            inherit: 'None'
            propagation: 'None'
          - user: 'BUILTIN\Users'
            rights: 'ReadAndExecute'
            inherit: 'None'
            propagation: 'None'
          - user: 'ALL APPLICATION PACKAGES'
            rights: 'ReadAndExecute'
            inherit: 'None'
            propagation: 'None'
   
    - name: "REMOVAL MEDIUM | V-57721 | PATCH | Event Viewer must be protected from unauthorized modification and deletion."
      win_acl_inheritance:
          path: 'C:\Windows\System32\Eventvwr.exe'
          state: absent
   
  when: "path_not_found not in event_viewer_audit.stderr and event_viewer_audit"
  tags:
      - cat2
      - medium
      - patch
      - V-57721
######################################### block end #####################################################
